<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter+</title>
    <!-- Bootstrap CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="assets/js/jquery.mtr-panel.js"></script>
    <script type="text/javascript" src="./assets/js/qr-code-styling.js"></script> 
    <link rel="stylesheet" href="base.css">
    <style>
        .navbar-panel-overlay {
            position: fixed;
            display: block;
            width: 100%;
            height: 100%;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            -webkit-transition-delay: 0s, 0s;
            transition-delay: 0s, 0s;
            -webkit-transition-duration: 0.38s, 0.38s;
            transition-duration: 0.38s, 0.38s;
            -webkit-transition-property: opacity, visibility;
            transition-property: opacity, visibility;
            -webkit-transition-timing-function: ease-in-out, ease-in-out;
            transition-timing-function: ease-in-out, ease-in-out; 
        }
        .navbar-panel-overlay.visible {
            opacity: 1;
            visibility: visible; 
        }
        .navbar-panel {
            position: fixed;
            z-index: 101;
            width: 256px;
            height: 100%;
            background-color: whitesmoke;
            box-sizing: border-box;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.23), 0 3px 12px rgba(0, 0, 0, 0.16);
            border: none;
            -webkit-transform: translateX(-300px);
            -ms-transform: translateX(-300px);
            transform: translateX(-300px); 
        }
        .navbar-panel.animated {
            -webkit-transition: 0.38s ease-in-out -webkit-transform;
            transition: 0.38s ease-in-out transform; 
        }
        .navbar-panel.visible {
            -webkit-transform: translateX(0);
            -ms-transform: translateX(0);
            transform: translateX(0); 
        }


        ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
        }

        ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom right, #61e9b9 0%, #61e9b9 100%);
        border-radius: 5px;
        }

        ::-webkit-scrollbar-track {
        background-color: #ddd;
        border: 1px solid #ccc;
        }

    </style> 
</head>
<body style="background-color: wheat;padding: 0px;">

  <div class="user user_1 container-fluid m-0" style="height: 100vh;overflow-y: auto;padding: 0px 20px;">
        <div class="col-12 col-sm-4 offset-sm-4 p-4 sombra" style="background:#ffffff;border-radius:10px;margin-top:25vh;height:auto;">
        <center style="margin: 10px 0px;">
            <a style="font-size:1.4em;margin-top: 20px;"><b style="color:#555555">WSP</b><b style="color: #61e9b9;"></b><img src="https://cdn-icons-png.flaticon.com/128/610/610413.png" alt="" style="width: 20px;"></a>
        </center>
        <div class="log log_2" style="display: none;text-align: center;">
        <input type="text" placeholder="Email" id="login_correo" class="form_login_input" autocomplete="off">
        <input type="password" placeholder="Password" id="login_clave" class="form_login_input" autocomplete="off">
        <button class="btn" id="btn_login" onclick="$('.form_login').show()" style="width:100%;margin-top: 10px;background-color: #25D366;color:#FFF;border: 1px solid #d4d4d4;"><img src="assets/img/password.png" alt="" style="width: 25px;margin-top: 0px;"> Send now!</button>
        <br><br>
        <a onclick="mostrar('log',1);" style="margin-top: 20px;cursor: pointer;font-size: .7em;margin-top: 5px;"><i class="zmdi zmdi-arrow-left"></i> Back</a>
        <br><br>
        <a onclick="mostrar('log',3);" style="margin-top: 20px;cursor: pointer;">Create an account</a>
        </div>
        <div class="log log_1">
            <button class="btn" id="btn_login" onclick="mostrar('log',2);setTimeout(()=>{$('.form_login_input').val('')},100)" style="width:100%;margin-top: 10px;background-color: #ffffff;color:#333333;border: 1px solid #d4d4d4;"><img src="assets/img/password.png" alt="" style="width: 25px;margin-top: 0px;"> Connect with your email</button>
            <button class="btn" id="btn_login" onclick="location.href='/login/logingoogle'" style="width:100%;margin-top: 10px;background-color: #ffffff;color:#333333;border: 1px solid #d4d4d4;"><img src="assets/img/google.png" alt="" style="width: 19px;margin-top: -2px;"> Connect with Google</button>
            <button class="btn" id="btn_login" onclick="location.href='login/loginfacebook'" style="width:100%;margin-top: 10px;background-color: #ffffff;color:#333333;border: 1px solid #d4d4d4;"><img src="assets/img/social-media.png" alt="" style="width: 24px;margin-top: -4px;"> Connect with Facebook </button>
        </div>
        <div class="log log_3" style="display: none;text-align: center;">
            <input type="text" placeholder="Name" id="new_name" class="form_login_input" autocomplete="off">
            <input type="text" placeholder="Email" id="new_email" class="form_login_input" autocomplete="off">
            <input type="password" placeholder="Password" id="new_password" class="form_login_input" autocomplete="off">
            <input type="password" placeholder="Repeat password" id="new_password2" class="form_login_input" autocomplete="off">
            <button class="btn" id="btn_create" onclick="" style="width:100%;margin-top: 10px;background-color: #25D366;color:#FFF;border: 1px solid #d4d4d4;">Create your account</button>
            <br>
            <p id="new_txt" style="margin-top: 20px;"></p>
            <a onclick="mostrar('log',2);" style="margin-top: 20px;cursor: pointer;font-size: .7em;margin-top: 5px;"><i class="zmdi zmdi-arrow-left"></i> Back</a>
        </div>
        </div>
  </div>  
  
  <div class="user user_2 container-fluid p-0 m-0">
    <div class="fixed-top p-0 capa capa_2 capa_3 capa_4 capa_5 capa_0 sombra" style="z-index: 1;background-color: #FFF;border:1px solid #ffffff;border-width: 0px 0px 1px 0px;">
        <div class="container-fluid p-0 m-0">
            <div class="row col-12 p-0  m-0">
            <div class="col-9 col-lg-12 p-2s" style="padding: 5px 0px 5px 50px;font-family: Logo;letter-spacing: 0.2em;">
                <a style="font-size:1.9em;margin-top: 10px;"><b style="color:#555555">Chatter</b><b style="color: #26D367;">+</b></a>
            </div>
            <div class="col-3 d-lg-none d-block" style="text-align: center;"><img class="menu-toggle" src="assets/img/menu.png" style="width: 40px;margin-top:13px;margin-right: 5px;"></div>
            </div>
        </div>
    </div>
    <div class="row m-0 p-0 " >
            <nav class="navbar-panel" style="padding: 10px;z-index: 999;background-color: #FFF;">
                <div class="col-12 p-0">
                    <ul class="nav nav-pills flex-column mb-auto p-0">
                    <li class="nav-item p-0" onclick="capa(2)" >
                        <b href="#" class="menu menu_2">
                            <img src="assets/icons/whatsapp.png"> Instances
                        </b>
                    </li>
                    <li class="p-0" style="display: none;" onclick="capa(4)">
                        <b href="#" class="menu menu_4"  >
                            <img src="assets/icons/conversation.png"> Get Started
                        </b>
                    </li>
                    <li class="p-0"  onclick="capa(5)">
                        <b href="#" class="menu menu_5">
                            <img src="assets/icons/folder.png"> Documentation
                        </b>
                    </li>
                    <li class="p-0" onclick="capa(3)">
                        <b href="#" class="menu menu_3" >
                            <img src="assets/icons/user.png"> Your account
                        </b>
                    </li>
                    <li class="p-0">
                        <b href="#" class="menu"  onclick="alertFun({text:`Are you sure to close your session?`,btn:`Close session`,functionModal:()=>{localStorage.clear();location.href=window.location.pathname}})"  style="color:red">
                            <img src="assets/icons/power-on.png"> Close Session
                        </b>
                    </li>
                    </ul>
                    
                </div>
            </nav>
            <!-- Menu BigScreen -->
            <div class="col-2 d-none d-lg-block" style="height: 100vh;border-width: 0px 1px 0px 0px;padding: 90px 20px 0px 20px;background-color: #fff">
                <div id="nav_lat" class="co-12 p-0"></div>
            </div> 
            <!-- Main Container -->
            <div class="col-lg-10 offset-lg-0 col-md-12" style="padding-top: 90px;height: 100vh;overflow-y: auto;">
                <div class="  row  capa capa_0">
                    <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
                </div>
                <div class="  row  capa capa_2 " style="padding: 0px 15px;">
                    <div class="col-lg-10 col-md-10 col-12 offset-lg-1 offset-md-1" style="padding: 0px;">
                        <button class="btn sombra d-none d-sm-block" id="btn_new_intance" onclick="mostrar('create',2);$('#phoneModal').modal('show');$('.nuevo_wsp').val('')" style="float:right;font-size:.8em">NEW INSTANCE</button>
                        <button class="btn sombra d-block d-sm-none" id="btn_new_intance_xs" onclick="mostrar('create',2);$('#phoneModal').modal('show');$('.nuevo_wsp').val('')" style="float:right;font-size:.8em">+</button>
                        <button class="btn sombra" onclick="buscar_phones()" style="float:right;font-size:.8em;margin-right: 3px;"> 
                            <img src="assets/img/refresh.png" style="width: 20px;"> </button>
                        <h2>YOUR INSTANCES</h2>
                        <button id="toggleSidebarBtn" style="display: none;">Toggle Sidebar</button>
                        <div class="col-12 p-0" id="div_phones" style="padding: 10px;">
                        </div>
                    </div>
                </div>
                <div class="  row  capa capa_3">
                            <div class="col-sm-9  col-xs-12" style="padding: 0px 20px;">
                                <div class="col-12" style="background-color: #ffffff0b;padding: 10px;border-radius: 10px;">
                                <h3>Your personal data</h3>
                                Name:
                                <input class="inputCapa" id="name_form_user" type="text">
                                Email 
                                <i class="zmdi zmdi-check" style="color: #26D367;display: none;" id="email_valid_form_user_check"></i>
                                <i class="zmdi zmdi-alert-triangle" style="color: #FFCC00;display: none;" id="email_valid_form_user_uncheck"></i>
                                <button class="btn btn-green btn-xs" onclick="sent_email_valid()" id="email_valid_form_user" style="display: none;padding: 2px;font-size: .7em;margin-top: -3px;margin-left: 5px;background-color: #ffcc00;margin-bottom: 5px;">Verify your email now!</button>
                                <input class="inputCapa" disabled id="email_form_user" type="text">
                                Plan: 
                                <input class="inputCapa" id="plan_form_user" type="text">
                                <button class="btn btn-green" onclick="sent_edit_user()">Edit user</button>
                                </div>
                            </div>
                </div>
                <div class="  row  capa capa_5 " style="padding:0px 15px;">
                    <div class="col-lg-10 col-md-10 col-12 offset-lg-1 offset-md-1" style="padding: 0px;">
                        <h1>API Documentation</h1>
                        <div class="code_show">
                            <div data="JSON">
                                var settings = {
                                    "url": "http://localhost:3000/api/instance/chat",
                                    "method": "POST",
                                    "timeout": 0,
                                    "headers": {
                                            "Content-Type": "application/json"
                                    },
                                    "data": '{
                                    "instanceId":"661a0903df86fba29a9a7aec",
                                    "senderId":"120363285709819764@g.us",
                                    "qty":20,
                                    "token":{{token}}}',
                                };
                            
                                $.ajax(settings).done(function (response) {
                                        console.log(response);
                                })
                            </div>
                            <div data="PHP">
                                asaws
                            </div>
                        </div>
                        <script>
                            $('.code_show').each(function() {
                                a=[]
                                $(this).find('div').each(function() {
                                    a.push({titulo:$(this).attr('data'),code:$(this).html()});
                                });
                                const x=showCode(a);
                                $(this).html(x)
                            });

                            function generarAleatorio(longitud) {
                            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                            let resultado = '';
                            for (let i = 0; i < longitud; i++) {
                                resultado += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
                            }
                            return resultado;
                            }
                              function showCode(codes){
                                btn="";codShow="";id=generarAleatorio(5)
                                codes.forEach((e,i) => {
                                    btn+=`<button class="btn btnCodeOp" style='background:${i>0?'#43485d':'#2F8A62'}' onclick="$('.code_${id}').hide();$('.code_${id}_${i}').show();$('.btnCodeOp').css('background','#43485d');$(this).css('background','#2F8A62');">${e.titulo}</button>`
                                    codShow+=`<pre class="code_${id} code_${id}_${i}" style="margin: 10px 0px 0px;padding: 0px;white-space: pre-wrap;display:${i>0?'none':'block'}"><code style="color:#25D366;">${e.code}</code></pre>`
                                });
                                return `<div class="col-12" style="color:#25D366;background-color: #000;padding:10px;border-radius: 10px;">
                                            ${btn}
                                            ${codShow}
                                        </div>`;
                              }
                              $(document).ready(function() {
                                $('code').each(function() {
                                var html = $(this).html();
                                html = html.replace(/"([^"]+)"/g, '<span style="color:#f869de">"$1"</span>'); // Resalta el texto entre comillas
                                html = html.replace(/&lt;span class="highlight"&gt;/g, '<span class="highlight">&lt;'); // Corrige el HTML escapado
                                html = html.replace(/&lt;\/span&gt;/g, '&lt;/span&gt;'); // Corrige el HTML escapado
                                html = html.replace(/\n\s+/g, '\n');
                                $(this).html(html);
                                });
                               });
                        </script>
                        <h2>Description</h2>
                        <p>This API provides functionalities for managing users and controlling messaging service instances (WhatsApp). It allows creating, modifying, and deleting users, as well as managing instances for sending messages.</p>
                    
                        <h2>Endpoints</h2>
                        <h3>Users</h3>
                        <h4>User Login</h4>
                        <pre><code>POST /login/users/login</code></pre>
                        <p>Logs in a user with existing credentials.</p>
                        <h5>Parameters:</h5>
                        <ul>
                            <li><code>email</code> (string): User's email address.</li>
                            <li><code>password</code> (string): User's password.</li>
                        </ul>
                    
                        <h4>Update User</h4>
                        <pre><code>POST /login/users/:uid</code></pre>
                        <p>Updates details of an existing user.</p>
                        <h5>Parameters:</h5>
                        <ul>
                            <li><code>uid</code> (string): Unique ID of the user to update in the database.</li>
                            <li><code>name</code> (string): New name of the user (optional).</li>
                            <li><code>email</code> (string): New email address of the user (optional).</li>
                            <li><code>password</code> (string): New password of the user (minimum 6 characters, optional).</li>
                            <li><code>status</code> (boolean): New status of the user (for admins only, optional).</li>
                        <li><code>token</code> (string): Valid JWT token, you must to login before.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="phoneModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">INSTANCE</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body create create_1">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body create create_2">
                <input class="nuevo_wsp" type="hidden" placeholder="Choose a name for your intance.." id="nuevo_id_wsp"> 
                <p>Instance name:</p>
                <input class="nuevo_wsp" type="text" placeholder="Choose a name for your intance.." id="nuevo_nro_wsp"> 
                <p>Webhooks URL:</p>
                <input class="nuevo_wsp" type="text" placeholder="Ej: https://mysite.com" id="nuevo_webhook_wsp"> 
                <p style="font-size:.8em;margin: 0px;color:rgb(107, 107, 107);font-style: oblique;">*Optional: Each time you'll receive a text we sent a notification to this url in a POST request.</p>
            </div>
            <div class="modal-body create create_3" style="text-align: center;">
                <b><i class="zmdi zmdi-check-all" style="color: #26D367;"></i> Your instance was created.</b>
                <br>
                <img src="assets/img/linkphone.png" style="width:50%;">
                <input type="hidden"id="form_create_success"> 
                <p style="font-size: .8em;">The next step is to connect your instance with your WhatsApp account. 
                    To do this you must go to your <b>WhatsApp > Settings > Linked devices > Link</b> new and scan the QR that we will show you.</p>
                <button class="btn btn-green" onclick="solicitar_qr_init()">Connect now <i class="zmdi zmdi-arrow-right"></i></button>
            </div>
            <div class="modal-footer create create_2 style="border:0px">
              <button type="button" class="btn" onclick="$('#nuevo_id_wsp').val()==''?agregar_numero_tel():editar_numero_tel()">Send</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="vincularModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Vincular dispositivo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body vincular vincular_1" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body vincular vincular_2" style="height:300px;font-weight:100;font-size:0.8em;display: none;">
                <input type="hidden" id="qr_nro">
                <center><div id="qr_wsp" style="text-align:center;border-radius: 5px;padding: 0px;margin-top: -10px;"></div>  </center>
            </div>
            <div class="modal-body vincular vincular_3" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div>
                <p>Connecting with your account...</p>
                </center>

            </div>
            <div class="modal-footer" style="border:0px">
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="alertModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Alert</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="alertModal_body" style="font-weight:100;">
                
            </div>
            <div class="modal-footer" style="border:0px" id="alertModal_btn_div">
                <button class="btn" id="alertModal_btn" onclick=""></button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="textModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Test your intance</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body textSend textSend_1" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body textSend textSend_2" style="font-weight:100;font-size:0.8em;display: none;">
                <input type="hidden" id="id_textSend">
                <select placeholder="Phone number ej: +549....." id="tipo_textSend" onchange="if($(this).val()=='Group' || $(this).val()=='Contact'){$('#to_textSend').show();$('#to_textSend').val('');$('#to1_textSend').hide();}else{$('#to1_textSend').show();$('#to_textSend').hide();};if($(this).val()=='NO'){$('#to1_textSend').hide();$('#to_textSend').hide();}; if($(this).val()=='Group'){$('.contact_contact').hide();$('.contact_group').show();};if($(this).val()=='Contact'){$('.contact_contact').show();$('.contact_group').hide();};">
                    <option value="NO" style="color:#d4d4d4" disabled>Choose one</option>
                    <option value="Group">Group</option>
                    <option value="Contact">Contact</option>
                    <option value="New">Other</option>
                </select>
                <select placeholder="Phone number ej: +549....." id="to_textSend">
                </select>
                <input type="text" placeholder="Phone number ej: +549....." id="to1_textSend">
                <textarea cols="30" rows="4" placeholder="Input your text here" id="text_textSend"></textarea>
                <p id="succ_msg"></p>
            </div>
            <div class="modal-footer" style="border:0px">
                <button class="btn" onclick="sendTextWsp()">Send text</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="eliminarModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">DELETE</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body eliminar eliminar_1" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body eliminar eliminar_2" style="font-size:0.8em;display: none">
                <input type="hidden" id="eliminar_id">
                Are you sure about delete this instance?
            </div>
            <div class="modal-footer eliminar eliminar_2" style="border:0px">
                <button type="button" class="btn" onclick="eliminar_numero()">Delete</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="campainModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Datos de envios</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="font-weight:100;font-size:0.8em">
                <input type="hidden" id="campain_buscar_id" value="">
                <table>
                    <thead>
                        <tr>
                            <th style="width:30px"></th>
                            <th>Destinatario</th>
                            <th>Estado</th>
                            <th>Enviado desde</th>
                            <th>Fecha Envio</th>
                        </tr>
                    </thead>
                    <tbody id="campainMensaje_tabla">
                        
                    </tbody>
                </table>   
            </div>
            <div class="modal-footer" style="border:0px">
              <button type="button" class="btn" style="display:none">Solicitar QR <i class="zmdi zmdi-arrow-right"></i></button>
            </div>
          </div>
        </div>
    </div>
  

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    instancias=[]
    
    
    function capa(i){
    $(".capa").hide();
    $('.menu').css("color","#000").css("border-width","0px");
    $('.menu_'+i).css("color","#25d365").css("border-width","0px 0px 4px 0px");;
    
    $(".capa_"+i).show()
    }
   
    $("#btn_login").on('click',()=>{
    iniciar_sesion();
    })
    $("#btn_create").on('click',()=>{
        problema="";$("#new_txt").html(problema);
        if($("#new_name").val().length<3){problema+="You must enter a name<br>";}   
        if($("#new_email").val().length<3){problema+="You must enter a email<br>";}   
        if($("#new_password").val().length<6 || $("#new_password").val()!=$("#new_password2").val()){problema+="Both password must be the same<br>";}   
        if(problema){$("#new_txt").html(problema);return;}
        create_account()
    })

    

    const create_account=()=>{
        env={};
        env["name"]= $("#new_name").val();
        env["email"]= $("#new_email").val();
        env["password"]= $("#new_password").val();
        console.log(env)
        ajax("/login/users",env,(d)=>{
            console.log(d)
            if(d.error){
                mostrar('log',3)
                analisis_error(d)
                return;
            }
            const e=d.data;
            mostrar('log',1)
            $(".log_1").append(`<p id='new_text_success'>Your accound has been created succesfuly.</p>`)
            setTimeout(() => {
                $("#new_text_success").remove()
            }, 2000);
            console.log(d)
        })
    }
    
    let eventQr=false;qrActual=""
    function checkQr(idI) {
        console.log("Check QR")
        console.log("checking")
        env={};
        env["token"]=user.token;
        env["instanceId"]=idI;
        ajax("/api/instance/get",env,(d)=>{
            const e=d.data;
            console.log("buscando", eventQr,e.instances[0].session,e)
            const newStatus=e.instances[0].session;
            switch (newStatus) {
                case 'connected':
                    $("#vincularModal").modal('hide');
                    buscar_phones();
                    break;
                case 'close':
                    eventQr=false;$("#vincularModal").modal('hide');
                    alertFun({text:"The Qr has expired. Try generating a new qr again",btn:"Ok"})
                    break;
                case 'connecting':
                    mostrar('vincular',3);
                    setTimeout(()=>{checkQr(idI);},1000); 
                    break;
                default:
                    console.log("buscando", eventQr,e.instances[0].session,e)
                    if(eventQr && newStatus=='qr')
                    {
                        newQr=e.instances[0].sessionStatus.qr;
                        if(newQr!=$("#qr_value").val()){
                            mostrar('vincular',1);
                            setTimeout(() => {
                                mostrar('vincular',2);
                                crearQR(newQr,"qr_wsp");
                            }, 1000);
                        }
                        setTimeout(()=>{checkQr(idI);},1000); 
                    }
                break;
            }
        });
    }

    $("#vincularModal").on("hidden.bs.modal", function () {
       eventQr=false;
    });
    $("#vincularModal").on("shown.bs.modal", function () {
       eventQr=true;
    });

    function sendTextWsp(){
        env={};
        env["token"]=user.token;
        env["instanceId"]=$("#id_textSend").val();
        env["remoteJid"]=$("#to_textSend").val();
        env["message"]=$("#text_textSend").val();
        console.log(env)
        mostrar('textSend',1);
        ajax("/api/instance/send",env,(d)=>{
            console.log(d)
            const e=d.data
            mostrar('textSend',2);
            $("#text_textSend").val("");
            $('#succ_msg').append('<i class="zmdi zmdi-check-all" style="color:#26D367"></i>Message succesful.');
            setTimeout(()=>{$("#succ_msg").html("")},1500)
        })
    }

    const sent_email_valid=()=>{
        env={};
        env["token"]=user.token;
        console.log(env)
        capa(0)
        ajax("/login/users/sendvalidation",env,(d)=>{
            console.log(d)
            if(d.status==200){alertFun({text:`We have sent an email. Don't forget to check you spam.`,btn:`Ok`,functionModal:()=>{$("#alertModal").modal('hide')}});}
            capa(3)
        });
    }

    const sent_edit_user=()=>{
        env={};
        env["token"]=user.token;
        env["uid"]=user.user.uid;
        env["name"]=$("#name_form_user").val();
        env["email"]=$("#email_form_user").val();
        console.log(env)
        capa(0)
        ajax("/login/users/edit",env,(d)=>{
            console.log(d)
            user.user=d.data.user;
            localStorage.setItem("user",JSON.stringify(user));
            control_sesion(false)
            capa(3)
        });
    }
    
    
    const buscar_phones=(spiner=true)=>{
        if(spiner){
        capa(0)
        }
        env={};
        env["token"]=user.token;
        ajax("/api/instance/get",env,(d)=>{
            $("#div_phones").html("")
            capa(2);
            if(d.error){
                analisis_error(d);
                capa(2);
                return true;
            }
            const e=d.data
            capa(2)
            if(e.length==0)
            {
                $("#div_phones").html(`
                <center>
                <p style='font-size:1.7em;text-align:center;margin-top:50px'><i class='zmdi zmdi-mood-bad' style='color:#26D367'></i> You don't have intances!</p>
                <button class='btn btn-sm' onclick='$("#btn_new_intance").click()'>Create your first intance</button>
                </center>`);
                return true;
            }
            
            init=false
            instancias=e.instances;
            e.instances.forEach((b,i) => {
                $nros="";
                console.log(b.sessionStatus?.me?.name)
                b.session=='initializing'?init=true:false;
                $("#div_phones").append(`<div class="col-12" style="padding:4px 0px">
                    <div class="col-12 placa" style="cursor:default">
                        <button class="btn btn3 sombra" data="${b.uid}" onclick="eliminar_numero_modal($(this).attr('data'),'eliminado')" style="padding:2px 7px;float:right"><img src="assets/img/delete.png" style="height:18px"></button>
                        <button class="btn btn3 sombra" data="${b.uid}" onclick="editar_numero($(this).attr('data'))" style="padding:2px 7px;float:right;margin-right:2px"><img src="assets/img/settings.png" style="height:18px"></button>
                        <button class="btn btn3 sombra" data="${b.uid}" onclick="$('#textModal').modal('show');$('#tipo_textSend').val('NO');$('#to1_textSend').hide();$('#to_textSend').hide();mostrar('textSend',2);$('#id_textSend').val($(this).attr('data'));checkContacts()" style="padding:2px 7px;float:right;margin-right:2px"><img src="assets/img/send.png" style="height:18px"></button>
                        <div style="display:${b.session=='close' || b.session=='qr'?'block':'none'}">
                            <h3 style="margin:5px 0px;font-size:.7em;color:#333">Instance ID: ${b.uid || "No name"}</h3>
                            <h3 style="margin:5px 0px;font-size:.8em">${b.name || "No name"} ${b.sessionStatus?.me?.name || ""}</h3>
                            <h5 style='margin:0px 0px 0px 0px;font-weight:100;'>${b.number||"Disconnected"}</h5>
                            <p style="font-size:.8em;margin:0px 0px 0px 0px"><img src="./assets/img/disconnect.png" style="width:25px"> 
                                You must to allow the Whatsapp connection by QR.<a onclick="solicitar_qr('${b.uid}')" style="color:#26D367;cursor:pointer">
                                Scan QR Code now !</a>
                            </p>
                        </div>
                        <div style="display:${b.session=='connected'?'block':'none'}"">
                            <h3 style="margin:5px 0px;font-size:.7em;color:#333">Instance ID: ${b.uid || "No name"}</h3>
                            <h3 style="margin:5px 0px;font-size:.8em">${b.name || "No name"}</h3>
                            <h5 style='margin:0px 0px 0px 0px;font-weight:100;display:${b.session=='connected'?'block':'none'}'>${b.number||""}</h5>
                            <p style="font-size:.8em;margin:0px"><img src="./assets/img/check.png" style="width:14px"> Connected</p>
                        </div>
                        <div style="font-size:.8em;display:${b.session=='initializing'?'block':'none'}"">
                            <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> Starting instance
                        </div>
                        <div id="connection_${b.nro}"></div>
                    </div>
                </div>`);
                actualizar_connection(b.nro,b.connection)  
            });
            if(init){
                setTimeout(()=>{console.log("buscando");buscar_phones(false);},1000)
                
            }
        })
    }

    function checkContacts(){
        env={};
        env["token"]=user.token;env["instanceId"]= $('#id_textSend').val();
        $("#to_textSend").html('')
        ajax("/api/instance/contacts",env,(d)=>{
            const e=d.data;
            contactsKeys=Object.keys(e.contacts);
            newArray=[]
            contactsKeys.forEach(x => {
                const c=e.contacts[x]
                newArray.push({id:c.id,name:c.name||'zzzzzzzzzzzzzzzzzzzzNo Name'})
            });
            // Ordenar newArray por el campo 'name'
            newArray.sort((a, b) => {
                // Convertir ambos nombres a minúsculas para una comparación sin distinción entre mayúsculas y minúsculas
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();

                // Comparar los nombres y devolver el resultado de la comparación
                if (nameA < nameB) {
                    return -1; // Si el nombre de 'a' es menor que el nombre de 'b', devuelve un número negativo
                }
                if (nameA > nameB) {
                    return 1; // Si el nombre de 'a' es mayor que el nombre de 'b', devuelve un número positivo
                }
                return 0; // Si los nombres son iguales, devuelve 0
            });
            newArray.forEach(x => {
                const c=e.contacts[x.id];
                //console.log(c)
                //console.log("+"+c.id.split("@")[0],c.name||"No name")
                $("#to_textSend").append(`<option value="${c.id}" class="${c.id?.indexOf('@g.us')>-1?"contact_group":"contact_contact"}">${c.name||"No name"} (${c.id})</option>`)
            });
        })
    }

    function actualizar_connection(nro,connection){
        $("#connection_"+nro).html(`
        
        <p style="font-size:.7em;margin:0px;display:${connection=='online'?'block':'none'}"><img src="img/active.png" width="20">CONECTADO</p>
        <p style="font-size:.7em;margin:0px;display:${connection=='inicializando'?'block':'none'}"><img src="img/init.gif" style="width:15;margin:0px 4px">CONECTANDO..</p>
        <p style="font-size:.7em;margin:0px;display:${connection=='stop'?'block':'none'}"><img src="img/desactive.png" style="width:15px;margin:0px 4px">DESCONECTADO</p>
        <p style="font-size:.7em;margin:0px;display:${connection=='qr'?'block':'none'}"><img src="img/qr.png" style="width:15px;margin:0px 4px">DESVINCULADO <button class="btn sombra"  onclick="$('#qr_nro').val('${nro}');mostrar('vincular',1);$('#vincularModal').modal('show')" style="background:#FFF;padding:3px 5px;font-size:.8em;margin:0px;margin-top:0px"> Vincular</button></p>
        `)
    }

    function mostrar(capa,i){
        $("."+capa).hide();
        $("."+capa+"_"+i).show();
    }
    
    function crearQR(data,divId){
        const qrCode = new QRCodeStyling({
            width: 250,
            height: 250,
            type: "svg",
            data,
            image: "assets/img/base.png",
            dotsOptions: {
                color: "#282828",
                type: "rounded"
            },
            backgroundOptions: {
                color: "#28282800",
            },
            imageOptions: {
                crossOrigin: "anonymous",
                margin: 1
            }
        });
        $('#'+divId).html(`<input type="hidden" id="qr_value" value="${data}">`)
        qrCode.append(document.getElementById(divId));
    }
    

    function solicitar_codigo(nro){
        env={}
        env.nro=nro;env.token=user.token;
        ajax("/api/phone/codigo",env,(d)=>{
            const e=d.data;
            if(e.error){alert("No se pudo modificar");return false;}
            console.log(e);
            alert("código enviado")
        })
    }

    function verificar_codigo(nro){
        env={}
        env.nro=nro;env.token=user.token;env.cod=$("#codigo_phone").val()
        ajax("/api/phone/validar",env,(d)=>{
            const e=d.data;
            console.log(e);
            if(e.error){alert(e.error);return false;}
            buscar_phones();
        })
    }

    function editar_numero(id) {
        $("#phoneModal").modal('show');
        mostrar('create',2);
        console.log(instancias)
        instancia=instancias.find(a=>a.uid==id)
        console.log(instancia.name,instancia)
        $("#nuevo_nro_wsp").val(instancia.name);
        $("#nuevo_id_wsp").val(instancia.uid);
        $("#nuevo_webhook_wsp").val(instancia.webhook)
    }

    function editar_numero_tel(){
        env={}
        env.name=$("#nuevo_nro_wsp").val();
        env.webhook=$("#nuevo_webhook_wsp").val();
        env.instanceId=$("#nuevo_id_wsp").val();
        env.token=user.token;
        mostrar('create',1)
        ajax("/api/instance/edit",env,(d)=>{
            const e=d.data;
            console.log(e);
            if(e.error){alert(e.error);return false;}
            $("#phoneModal").modal('hide');
            buscar_phones(true);
        })
    }

    function agregar_numero_tel(){
        nro=$("#nuevo_nro_wsp").val()
        env={}
        env.name=nro;env.token=user.token;
        mostrar('create',1)
        ajax("/api/instance/create",env,(d)=>{
            const e=d.data;
            console.log(e);
            if(e.error){alert(e.error);return false;}
            $('#form_create_success').val(e.instance.uid);
            mostrar('create',3)
            buscar_phones();
        })
    }

    function solicitar_qr_init(){
        solicitar_qr($("#form_create_success").val());
        $('#phoneModal').modal('hide');
    }

    function solicitar_qr(idI){
        mostrar('vincular',1)
        $('#vincularModal').modal('show');
        env={}
        env.instanceId=idI;env.token=user.token;
        ajax("/api/instance/init",env,(d)=>{
            const e=d.data;
            console.log(e);
            if(e.error){alert(e.error);return false;}
            if(e.instance.qr!=""){
                mostrar('vincular',2)
                crearQR(e.instance.qr,"qr_wsp");
                checkQr(idI)
            }else{
                setTimeout(()=>{solicitar_qr(idI);},1400)
            }
        })
    }
    

    function eliminar_numero(){
        env={}
        env.instanceId=$("#eliminar_id").val();env.token=user.token;
        mostrar('eliminar',1)
        ajax("/api/instance/delete",env,(d)=>{
            const e=d.data;
            if(e.error){alert("No se pudo modificar");return false;}
            console.log(e);
            $("#eliminarModal").modal('hide');
            buscar_phones()            
        })
    }
    function eliminar_numero_modal(idI){
        $("#eliminarModal").modal('show');
        mostrar('eliminar',2)  
        $("#eliminar_id").val(idI)
    }

    const iniciar_sesion=()=>{
        env={};
        env["correo"]= $("#login_correo").val();
        env["clave"] = $("#login_clave").val();
        ajax("/login/users/login",env,(d)=>{
            const e=d.data;
            if(d.error){
                mostrar('log',2)
                analisis_error(d)
                return;
            }
            localStorage.setItem("user",JSON.stringify(e))
            control_sesion();
        })
    }

    function ajax(url,json_dat,callback,error=(e)=>{console.log(e)}){
            let token="Bearer"
            if(json_dat?.token){
                 token=`Bearer ${json_dat.token}`
            }
            console.log("token",token)
            $.ajax({url,type:"POST",headers: {"Content-Type": "application/json","Authorization": token},dataType : 'json',data: JSON.stringify(json_dat),success: function(data, textStatus, jqXHR){callback(data)},error: function( jqXHR, textStatus, errorThrown ) {error();}});
    }

    $("#nro").on('keyup',(e)=>{
        if(e.keyCode==13){add_nro();}
    })

    function add_nro(){
        nros=$("#nro").val().split(";");
        nros.forEach(nro => {
            if(nro==""){return}
            $("#div_nro").append(`
            <b class="btn nroSaved" data="${nro}" style="margin-top:4px;border:1px solid grey;padding:1px 5px">${nro} <a onclick="$(this).parent().remove()" style="font-weight:100;font-size:1.2em"><i class="zmdi zmdi-close-circle-o"></i></a></b>
            `);
        });
        $("#nro").val("")
    }

    

    $(window).on('load',()=>{
        const token=getParameterByName("token")
        if(token){
            checktoken(token)
        }
        //alert(token)
    })

    function checktoken(token,id){
        env={token};
        ajax("/login/users/check",env,(d)=>{
            const e=d.data;
            if(d.error){
                analisis_error(d)
                return;
            }
            localStorage.setItem("user",JSON.stringify(e))
            const accion=getParameterByName("accion")
            if(accion){alertFun({text:'Your email has been successfully validated',btn:"Go to my account",functionModal:()=>{location.href=window.location.pathname;}});setTimeout(()=>{location.href=window.location.pathname},2000);return;}
            location.href=window.location.pathname
            control_sesion();
        })
    }
    

    function fecha(fc,seg){
        fc=new Date(fc);
        ms=fc.getMonth()+1;ms<10?ms="0"+ms:true;
        d=fc.getDate();d<10?d="0"+d:true;
        h=fc.getHours();h<10?h="0"+h:true;
        m=fc.getMinutes();m<10?m="0"+m:true;
        s="";if(seg){s=fc.getSeconds();s<10?s="0"+s:true;s=":"+s;}
        return h+":"+m+s+" "+d+"/"+ms+"/"+fc.getFullYear();
    }

    mostrar('user',1)
    control_sesion();
    function control_sesion(buscar=true){
        user=JSON.parse(localStorage.getItem("user"))
        console.log(user)
        if(user){
            mostrar('user',2)
            capa(2)
            if(buscar){buscar_phones();}
            $("#account_name").html(user.user.nombre);
            $("#name_form_user").val(user.user.nombre)
            $("#email_form_user").val(user.user.correo)
            if(!user.user.email_valid){$("#email_valid_form_user").show()}
            if(!user.user.email_valid){$("#email_valid_form_user_uncheck").show()}
            if(user.user.email_valid){$("#email_valid_form_user_check").show()}
            $("#plan_form_user").val(user.user.plan)
        }
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function alertFun({text,btn,functionModal=()=>{$("#alertModal").modal('hide');}}) {
        $("#alertModal").modal('show')
        $("#alertModal_body").html(text);
        if(btn){
            $("#alertModal_btn_div").show();
            $("#alertModal_btn").html(btn);
            $("#alertModal_btn").on('click',functionModal)
        }else{
            $("#alertModal_btn_div").hide();
        }
    }

    const analisis_error=(d)=>{
        text=d.message;
        if(d?.data?.errors){
            if(d.data.errors[0]?.msg=="Invalid token"){localStorage.clear();location.href=window.location.pathname;}
            console.log(d.data.errors)
            text+=`<br>`;
            d.data.errors.forEach(a=>{
                text+=`<br>${a.msg}.`
            })
        }
        alertFun({text});
        return false;
    }


</script>
  <script>
    $(function() {
        $('.navbar-panel').mtrPanel({toggle: '.menu-toggle'});
    })
    $(document).ready(function(){
      const panel=$(".navbar-panel").html();
      function alertOnDesktop(){
        if($(window).width() > 992){ // Tamaño para computadora (puedes ajustar el valor según tus necesidades)
            $("#nav_lat").html(panel)
            $(".navbar-panel").html("")
            $("#nav_lat").css("padding","20px 10px")
        }else{
            $("#nav_lat").html("")
            $(".navbar-panel").html(panel)
        }
      }
      alertOnDesktop(); // Llamada inicial
      
      $(window).resize(function(){
        alertOnDesktop(); // Llamada cuando cambia el tamaño de la pantalla
      });
    });
    function capa(i){
        $(".capa").hide();
        $('.menu').css("color","#000").css("border-width","0px");
        $('.menu_'+i).css("color","#25d365").css("border-width","0px 0px 4px 0px");;
        
        $(".capa_"+i).show()
    }
  </script>
</body>
</html>

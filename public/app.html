<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K17RP1YVV3"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-K17RP1YVV3');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
    <link rel="canonical" href="https://chatter.plus/app">
    <meta name="theme-color" content="#333333" />
    <title>Chatter+</title>
    <!-- Bootstrap CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="assets/js/jquery.mtr-panel.js"></script>
    <script type="text/javascript" src="./assets/js/qr-code-styling.js"></script> 
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="stylesheet" href="assets/css/checkanimation.css">
</head>
<style>
    input{
        color:#FFF
    }
    .option-image {
        vertical-align: middle;
        margin-right: 10px; /* Espacio entre la imagen y el texto */
        max-width: 20px; /* Ancho máximo de la imagen */
        max-height: 20px; /* Altura máxima de la imagen */
    }
</style>
<body style="padding: 0px;background-color: #353535;color:#FFF">
    <div class="user user_1 container-fluid m-0" style="display: none ;height: 100vh;overflow-y: auto;padding: 0px 20px;color:#FFF;background: linear-gradient(180deg, rgba(83,83,83,1) 0%, rgba(87,176,137,1) 78%, rgba(90,228,168,1) 100%);">
        <div class="capa capa_0">
        <center style="margin-top: 32vh;">
            <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
        </center>
        </div>
        <div class="capa capa_100 p-0" style="display: none;">
            <div class="col-12 col-lg-4 offset-lg-4" style="padding: 10px;margin-top: 20vh;">
                <div class="col-12" style="background-color: rgba(255,255,255,.12);color:#FFF;padding: 30px;border-radius: 10px;text-align: center;">
                    <a class="nav-link" style="font-size:1.9em;margin-top: 0px;font-family: Square;">
                        <b style="color:#e4e4e4">chAtter</b><b style="color: #5AE4A8">+</b></a>
                        <p style="font-size: .9em;margin-top: 10px;">You must to verify your email. We have sent a email with a link to validate your email address. Do not forget to check your Spam.</p>
                        <button class="btn btn-green" onclick="sent_email_valid()">Resend email validation</button>                        
                </div>
            </div>
        </div>

        <div class="capa capa_102 p-0" style="display: none;">
            <div class="col-12 col-lg-4 offset-lg-4" style="padding: 10px;margin-top: 20vh;">
                <div class="col-12 m-0" style="color:#FFF;padding: 0px;border-radius: 10px;text-align: center;">
                        <h3 class="title_pass" style="margin:30px 0px;">Please, set a password to continue...</h3>
                        <div class="old_pass">
                        <input type="password" placeholder="Current password" id="old_password">
                        </div>
                        <input type="password" placeholder="New password" id="new_password_1">
                        <input type="password" placeholder="Repeat your new password" id="new_password_2" >
                        <p id="new_password_alert" style="color:rgb(237, 150, 150);margin-top: 0px;padding: 0px 10px;"></p>
                        <button class="btn old_pass" style="background-color: #ffffff2c;color:#FFF" onclick="mostrar('user',2);capa(3)"><i class="zmdi zmdi-arrow-left"></i> Cancel</button>  
                        <button class="btn btn-green" onclick="set_password()">Continue</button>                        
                </div>
            </div>
        </div>

        <div class="capa capa_103 p-0" style="display: none;">
            <div class="col-12 col-lg-4 offset-lg-4" style="padding: 10px;margin-top: 20vh;">
                <div class="col-12 m-0" style="color:#FFF;padding: 0px;border-radius: 10px;text-align: center;">
                    <center>
                        <div class="check"></div>
                    </center>
                    <h1 class="animated-text" style="margin-top: 10px;">Your account is ready!</h1>  
                    <p class="animated-text">
                        If you chose a paid plan, the first month we will deduct the corresponding amount from your bill. It does not apply to extra instances that you consume.
                    </p>   
                    <button id="btn-animation" class="btn" style="background-color: #FFF;color:#959595;margin-top: 30px;display: none;" onclick="control_sesion(true)">Continue</button>             
                </div>
            </div>
        </div>

        
        <div class="capa capa_101 p-0 row" style="display: none;">
            <div class="col-12 col-lg-10 offset-lg-1 " style="padding: 10px;margin-top: 0vh;">
                <div class="col-12 m-0" style="color:#FFF;padding: 0px;border-radius: 10px;text-align: center;">
                    <button class="btn btn_back_plan" style="float: left;background-color: #ffffff2c;color:#FFF" onclick="mostrar('user',2);capa(3)"><i class="zmdi zmdi-arrow-left"></i> Go back</button>  
                    <br>  
                    <h2 style="margin-top: 30px;font-family: Sans;">Please, choose your plan :)</h2>
                        <div class="row col-12 col-lg-10 offset-lg-1">
                        <div class="carrusel">
                            <div class="col-lg-10 offset-lg-1 carrusel_div d-flex flex-nowrap" style="text-align: center;">
                                <div class="col-9 col-lg-6"  style="padding: 0px 3px;">
                                <div class="col-12 sombra" style="font-family: Sans;background-color: #FFF;border-radius: 10px;padding: 10px;color:#000;">
                                    <h2 style="margin-top: 10px;border:1px solid #d1d1d1;border-width: 0px 0px 1px 0px;">Free</h2>
                                    <h1 style="font-size: 4em;font-family: Sans;color:#000">$0</h1>
                                    <p style="margin: -10px 0px 10px 0px;color:#afafaf00">.</p>
                                    <p style="margin: 0px;">3 Free and trial instances.<qs data="Free instance:<br>Limit 10.000 message/Month or 500 message/day<br><br><br>Trial instance:<br>All features (Automatic restart every 7 days).">?</qs></p>
                                    <p style="margin: 0px;">Unlimited messages.</p>
                                    <p style="margin: 0px;">WebHook Notifications.</p>
                                    <p style="margin: 0px;">Media Download.<qs data="Low Quality (20% of real one)">*</qs></p>
                                    <p style="margin: 0px;">No email support.</p>
                                    <hr style="border: 0px;color:#00000000;background-color: #00000000;">
                                    <p style="margin: 0px;font-family: Logo;color:#00000000">.</p>
                                    <button class="btn btn-black btn_start" data="1" style="margin-top: 10px;width: 100%;">Choose Plan</button>
                                </div>
                                </div>
                                <div class="col-9 col-lg-6" style="padding: 0px 3px;">
                                    <div class="col-12 sombra" style="font-family: Sans;background-color: #FFF;border-radius: 10px;padding: 10px;color:#000;">
                                        <h2 style="margin-top: 10px;border:1px solid #d1d1d1;border-width: 0px 0px 1px 0px;">Premium</h2>
                                        <h1 style="font-size: 4em;font-family: Sans;color:#000">$1.99</h1>
                                        <p style="margin: -10px 0px 10px 0px;color:#afafaf">Per intance / month.</p>
                                        <p style="margin: 0px;">3 Free or trial instances.</p>
                                        <p style="margin: 0px;">Unlimited messages.</p>
                                        <p style="margin: 0px;">WebHook Notifications.</p>
                                        <p style="margin: 0px;">Media Download.</p>
                                        <p style="margin: 0px;">Email support.</p>
                                        <hr>
                                        <p style="margin: 0px;font-family: Logo;color:#519c78;font-weight: 600;"><img src="https://static-00.iconduck.com/assets.00/gift-icon-1947x2048-6pyurw96.png" style="width: 25px;margin-right: 5px;">Get $10 as a gift!</p>
                                        <button class="btn btn-black btn_start" data="2" style="margin-top: 10px;width: 100%;">Choose Plan</button>
                                    </div>
                                </div>
                            </div>
                        </div>               
                        </div>
                </div>
            </div>
        </div>  
  </div>
  <div class="user user_2 container-fluid p-0 m-0" style="display: none ">
    <div class="fixed-top p-0 capa capa_2 capa_3 capa_4 capa_5 capa_6 capa_0 sombra" style="z-index:4;background:#FFF;border: 0px">
        <div class="container-fluid p-0 m-0">
            <div class="row col-12 p-0  m-0 sombra" style="background-color: #333333;">
            <div class="col-8 col-lg-2 offset-lg-0 p-2s" style="padding: 10px 0px 5px 15px;font-family: Logo;letter-spacing: 0.2em;">
                <a class="nav-link" style="font-size:1.9em;margin-top: 0px;font-family: Square;">
                    <b style="color:#e4e4e4">chAtter</b><b style="color: #5AE4A8">+</b></a>
            </div>
            <div class="col-lg-5 offset-lg-2 d-lg-block d-none p-2s " style="padding: 25px 0px;font-family: Logo;letter-spacing: 0.1em;font-weight:600;">
                     
            </div>
            <div class="col-lg-3 offset-lg-0 d-lg-block d-none p-2s " style="padding: 10px 0px;font-family: Logo;letter-spacing: 0.1em;">
                         
            </div>

            <div class="col-4 d-lg-none d-block" style="text-align: right;padding-top: 1px;">
                <img class="menu-toggle" src="https://icons.veryicon.com/png/o/miscellaneous/linear-icon-45/hamburger-menu-5.png" alt="Open Menu icon" style="float:right;width: 40px;margin-top:12px;margin-right: 2px;filter: invert(.8);">
            </div>
            </div>
        </div>
    </div>
    <div class="row m-0 p-0 " >
            <!-- Menu Tablet phone -->
            <nav class="navbar-panel" style="padding: 10px;z-index: 999;background-color: #FFF;">
                <a style="font-size:1.9em;margin-top: 10px;font-family: Square;"><b style="color:#555555">Chatter</b><b style="color: #26D367;">+</b></a>
                <div class="col-12" id="navbar_container" style="padding:10px 0px;">
                    <ul  class="nav nav-pills flex-column mb-auto p-0  " style="margin-top: 10px;">
                    <li class="nav-item p-0" onclick="capa(2)" >
                        <b href="#" class="menu menu_2 ">
                            Instances
                        </b>
                    </li>
                    <li class="p-0" style="" onclick="capa(4)">
                        <b href="#" class="menu menu_4 "  >
                            Api Keys
                        </b>
                    </li>
                    <li onclick="capa(5);if(!$('iframe').attr('src')){$('iframe').attr('src','documentation.html')}" class="p-0"  >
                        <b href="#" class="menu menu_5"  >
                            Documentation
                        </b>
                    </li>
                    <li class="p-0" onclick="capa(3)">
                        <b href="#" class="menu menu_3" >
                            Account Settings
                        </b>
                    </li>
                    <li class="p-0" onclick="capa(6)">
                        <b href="#" class="menu menu_6" >
                            Bills
                        </b>
                    </li>
                    <li class="p-0">
                        <b href="#" class="menu"  onclick="alertFun({text:`Are you sure to close your session?`,btn:`Close session`,functionModal:()=>{localStorage.clear();location.href='index.html'}})"  style="color:red">
                            Close Session
                        </b>
                    </li>
                    </ul>
                    
                </div>
            </nav>
            <!-- Menu BigScreen -->
            <div class="col-2 d-none d-lg-block sombra" style="font-family: Logo;height: 100vh;border:0px solid #f5f5f5;border-width: 0px 0px 0px 0px;padding: 90px 20px 0px 20px;background-color: #3e3e3e;">
                <div id="nav_lat" class="co-12 p-0" style="color:#FFF"></div>
            </div> 
            <!-- Main Container -->
            <div class="col-lg-10 col-md-12 m-0" style="padding: 60px 0px 0px 0px;height: 100vh;overflow-y: auto;">
                <div class="  row  capa capa_0 m-0" style="padding-top: 25vh;">
                    <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
                </div>
                <div class="  row  capa capa_2 m-0" style="padding: 30px 15px 0px 15px;">
                    <div class="col-lg-10 col-md-10 col-12 offset-lg-1 offset-md-1" style="padding: 0px;">
                        <button class="btn btn-green d-none d-sm-block" id="btn_new_intance" onclick="open_phone_modal()" style="float:right;font-size:.8em">NEW INSTANCE</button>
                        <button class="btn btn-green d-block d-sm-none" id="btn_new_intance_xs" onclick="mostrar('create',2);$('#phoneModal').modal('show');$('.nuevo_wsp').val('')" style="float:right;font-size:.8em">+</button>
                        <button class="btn btn-green" onclick="buscar_phones()" style="float:right;font-size:.8em;margin-right: 3px;"> 
                            <img src="assets/img/refresh.png" style="width: 16px;"> </button>
                        <h2>Instances</h2>
                        <p>Get your API KEY <a style="color: #5AE4A8;cursor: pointer;" onclick="capa(4)">Here</a> to interact with your API instance.</p>
                        <button id="toggleSidebarBtn" style="display: none;">Toggle Sidebar</button>
                        <div class="col-12 p-0" id="div_phones" style="padding: 10px 0px;">
                        </div>
                    </div>
                </div>
                <div class="  row  capa capa_4 m-0" style="padding: 30px 15px 0px 15px;">
                    <div class="col-lg-10 col-md-10 col-12 offset-lg-1 offset-md-1" style="padding: 0px;">
                        <button class="btn btn-green d-none d-sm-block" id="btn_new_intance" onclick="mostrar('token',2);$('#tokenModal').modal('show');$('.nuevo_token').val('')" style="float:right;font-size:.8em">NEW API KEY</button>
                        <button class="btn btn-green d-block d-sm-none" id="btn_new_intance_xs" onclick="mostrar('token',2);$('#tokenModal').modal('show');$('.nuevo_token').val('')" style="float:right;font-size:.8em">+</button>
                        <button class="btn btn-green" onclick="buscar_token(true)" style="float:right;font-size:.8em;margin-right: 3px;"> 
                            <img src="assets/img/refresh.png" style="width: 16px;"> </button>
                        <h2>API KEYS</h2>
                        <p>Create here your API Key to interact with your API instance.</p>
                        <button id="toggleSidebarBtn" style="display: none;">Toggle Sidebar</button>
                        <div class="col-12 p-0" id="div_tokens" style="padding: 10px 0px;">
                        </div>
                    </div>
                </div>

                <div class="  row  capa capa_6 m-0" style="padding: 30px 15px 0px 15px;">
                    <div class="col-lg-10 col-md-10 col-12 offset-lg-1 offset-md-1 row" style="padding: 0px;">
                        <div class="col-12 col-md-8 col-lg-7 row" style="padding: 0px 20px;">
                            <h4>Your Consumption</h4> 
                            <div class="col-3">
                                Month
                                <select id="consumption_month"  style="padding-left: 0px;background-color: rgb(255,255,255,.2);"></select>
                            </div>
                            <div class="col-5">
                                Year:
                                <select id="consumption_year" style="padding-left:0px;;background-color: rgb(255,255,255,.2);"></select>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-green" style="margin-top: 15px;" onclick="buscar_consumptions()">Search</button>
                            </div>
                            <h1 id="total_consumptions"></h1>
                            <div class="col-12" id="consumptions">

                            </div>
                            <hr>
                            <h4>Your Pending Payments <b id="totalAmount" style="color: rgb(255,255,255,.8);"></b></h4> 
                            <div id="charges" class="row" style="padding: 0px 10px"></div>
                            <p class="btn_pay_now" style="margin-top: 10px;text-align: left;font-size: .9em;">Total selected <b id="totalAmountPay" style="color: #5AE4A8;"></b>
                            <button class="btn " style="background:#b03ec3;color:#FFF;width: auto;margin-top: -2px;padding:3px 8px;font-size: .8em;" onclick="$('#payNow').modal('show');mostrar('payDiv',2);">Pay Now</button>
                            </p>
                        </div>
                        <div class="col-12 col-md-4 col-lg-5" style="padding: 0px 20px;">
                            <div class="col-12 p-0">
                                <button class="btn btn-green" style="float: right;padding:0px 0px 7px 2px;" onclick="$('#newCard').modal('show');mostrar('cardAdm',2)"><img src="assets/img/edit.png" style="width: 30px;"></button>
                                <h4>Your Cards</h4>
                                <p><b id="cards_number"></b> Card(s) registered</p> 
                                <hr>
                            </div>
                            <div class="col-12 p-0">
                                <h4>Your Payments</h4> 
                                <div id="payments" class="row" style="max-height: 50vh;overflow-y: auto;padding:0px 10px">
                                </div>
                            </div>
                        </div>  
                        
                        
                    </div>
                </div>
                
                <div class="  row  capa capa_3 m-0 p-0">
                            <div class="col-sm-10  col-xs-12 offset-sm-1" style="padding: 30px 20px;">
                                <div class="col-12" style="padding: 0px;border-radius: 10px;">
                                <h3>Account</h3>
                                <hr>
                                <h5>Your Plan</h5>
                                <h1 class="plan_form_user plan_form_user_1" style="font-size: Sans;">Free Plan</h1>
                                <h1 class="plan_form_user plan_form_user_2" style="font-size: Sans;"><b style="color: #5AE4A8;">Premium</b> Plan</h1>
                                <button class="btn btn-green" style="background:#4e9bde;color:#FFF" onclick="mostrar('user',1);capa(101);">Change you plan</button>
                                <button class="btn btn-green" onclick="mostrar('user',1);capa(101);">Admin you plan</button>
                                <hr>
                                <h5>Personal data</h5>
                                Name:
                                <input class="inputCapa" id="name_form_user" type="text">
                                Email 
                                <i class="zmdi zmdi-check" style="color: #26D367;display: none;" id="email_valid_form_user_check"></i>
                                <i class="zmdi zmdi-alert-triangle" style="color: #FFCC00;display: none;" id="email_valid_form_user_uncheck"></i>
                                <button class="btn btn-green btn-xs" onclick="sent_email_valid()" id="email_valid_form_user" style="display: none;padding: 2px;font-size: .7em;margin-top: -3px;margin-left: 5px;background-color: #ffcc00;margin-bottom: 5px;">Verify your email now!</button>
                                <input class="inputCapa" disabled id="email_form_user" type="text">
                                <button class="btn btn-green" onclick="sent_edit_user()">Edit user</button>
                                <hr>
                                <h5>Password</h5>
                                <button class="btn btn-green" onclick="open_pass_modal(true)">Change Password</button>
                                
                                </div>
                                
                            </div>
                </div>
                <div class="  row  capa capa_5 m-0 p-0 " style="padding:0px;">
                    <div class="col-lg-12 col-md-12 col-12 offset-md-1 p-0 m-0" style="padding: 0px;">
                        <iframe src="" frameborder="0" style="width: 100%;height: 88vh;"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="payNow" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content" style="background: #565656;color:#fbfbfb">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Pay Now</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"  style="font-weight:100;">
                <div class="row payDiv payDiv_1"style="padding: 10px 30px;">
                    <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
                </div>
                <div class="payDiv payDiv_2" style="padding: 10px;">
                    Are you sure about making this payment?
                    <br>
                    <select id="cardOption" placeholder="Cardholder Name" style="border-width: 0px;width: 100%; margin: 10px 0px;">
                    </select>
                    <p id="payNow_problem" style="color: rgb(255, 206, 206);margin-bottom: 0px;"></p>
                </div> 
                <div class="payDiv payDiv_3" style="padding: 10px;">
                    Your payment has been sent correctly.
                </div> 
                 
            </div>
            <div class="modal-footer" style="border:0px" id="alertModal_btn_div">
                <button class="btn payDiv payDiv_2" style="color:#5AE4A8;width: auto;;" onclick="paySum()">Pay now</button>
                <button class="btn payDiv payDiv_3" style="color:#5AE4A8;width: auto;;" onclick="$('#payNow').modal('hide')">Close</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="newCard" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
          <div class="modal-content" style="background: #565656;color:#fbfbfb">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Add New Card</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"style="font-weight:100;">
                <div class="row cardAdm cardAdm_1"style="padding: 10px 30px;">
                    <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
                </div>
                <div class="row cardAdm cardAdm_2" id="cards" style="padding: 10px 30px;"></div>
                <div class="cardAdm cardAdm_3" style="padding: 10px;">
                    Your name:
                    <input type="text" id="card-name" placeholder="Cardholder Name" autocomplete="off" style="border-width: 0px;width: 100%; margin: 10px 0px;">
                    Card data:
                    <div id="card-element" style="padding: 10px;margin: 10px 0px;background-color:#505050;border-radius: 4px;"></div>
                    <p id="addCard_problem" style="color: rgb(252, 213, 213);font-weight: 100;font-size:.9em"></p>
                </div> 
                <div class="cardAdm cardAdm_4" style="padding: 10px;text-align: center;">
                    Are you sure of delete this card?
                    <br><br>
                    <a style="color:#e9e9e9">
                    <img src="" id="deleteCard_payment_img" style="width: 30px;border:1px solid #fff;border-radius: 3px;"><b style="color:#565656">_</b>_ _ _ _  <b style="color:#565656">_</b> _ _ _ _  <b style="color:#565656">_</b> _ _ _ _  <b style="color:#565656">_</b> <b style="color: #e9e9e9;font-weight: 900;" id="deleteCard_payment_last"></b>
                    </a>
                    <input type="hidden" id="deleteCard_payment_id">
                </div>  
            </div>
            <div class="modal-footer" style="border:0px" id="alertModal_btn_div">
                <button type="button" class="btn cardAdm cardAdm_3" onclick="mostrar('cardAdm',2)">Cancel</button>
                <button type="button" class="btn cardAdm cardAdm_3" id="add-card-button">Add Card</button>
                <button class="btn cardAdm cardAdm_4" style="color:#5AE4A8;width: auto;;" onclick="delete_card()">Delete</button>
            </div>
          </div>
        </div>
    </div>

    <div class="modal" id="phoneModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">INSTANCE</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body create create_1">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body create create_2">
                <input class="nuevo_wsp" type="hidden" placeholder="Choose a name for your intance.." id="nuevo_id_wsp" autocomplete="off"> 
                <p>Instance name:</p>
                <input class="nuevo_wsp" type="text" placeholder="Choose a name for your intance.." id="nuevo_nro_wsp"  autocomplete="off"> 
                <p>Instance type (You won't be able to change it after it is created):</p>
                <div class="form-check radio_input_div" style="padding-left: 0px;">
                    <input type="radio" class="radio_input" name="nuevo_type_wsp" id="nuevo_type_wsp_1" style="width: 20px;margin: 0px;">
                    <label class="form-check-label" for="flexRadioDefault1" >
                        <b style="font-weight: 900;">Full:</b> All features
                    </label>
                  </div>
                  <div class="form-check radio_input_div" style="padding-left: 0px;">
                    <input type="radio" class="radio_input" name="nuevo_type_wsp" id="nuevo_type_wsp_2" style="width: 20px;margin: 0px;">
                    <label class="form-check-label" for="flexRadioDefault1" >
                        <b style="font-weight: 900;">Trial:</b> All features (Automatic restart every 7 days)
                    </label>
                  </div>
                  <div class="form-check radio_input_div" style="padding-left: 0px;">
                    <input type="radio" class="radio_input" name="nuevo_type_wsp" id="nuevo_type_wsp_3" style="width: 20px;margin: 0px;" checked>
                    <label class="form-check-label" for="flexRadioDefault1" >
                        <b style="font-weight: 900;">Free:</b> Limit features
                    </label>
                  </div>
                <p style="margin-top:20px">Webhooks URL:</p>
                <input class="nuevo_wsp" type="text" placeholder="Ej: https://mysite.com" id="nuevo_webhook_wsp"  autocomplete="off"> 
                <p style="font-size:.8em;margin: 0px;color:rgb(107, 107, 107);font-style: oblique;">*Optional: Each time you'll receive a text we sent a notification to this url in a POST request.</p>
                <p id="create_problem"></p>
            </div>
            <div class="modal-body create create_3" style="text-align: center;">
                <b><i class="zmdi zmdi-check-all" style="color: #26D367;"></i> Your instance was created.</b>
                <br>
                <img src="assets/img/linkphone.png" style="width:50%;">
                <input type="hidden"id="form_create_success"> 
                <p style="font-size: .8em;">The next step is to connect your instance with your WhatsApp account. 
                    To do this you must go to your <b>WhatsApp > Settings > Linked devices > Link</b> new and scan the QR that we will show you.</p>
                <button class="btn btn-green" onclick="solicitar_qr_init()">Connect now <i class="zmdi zmdi-arrow-right"></i></button>
            </div>
            <div class="modal-footer create create_2" style="border:0px">
              <button type="button" class="btn" onclick="$('#nuevo_id_wsp').val()==''?agregar_numero_tel():editar_numero_tel()">Send</button>
            </div>
          </div>
        </div>
    </div>
    
    <div class="modal" id="tokenModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">API KEY</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body token token_1">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body token token_2"> 
                <p>API KEY name:</p>
                <input class="nuevo_token" type="text" placeholder="Choose a name for your intance.." id="nuevo_name_token"> 
                <p style="font-size:.8em;margin: 0px;color:rgb(107, 107, 107);font-style: oblique;">*Optional: Each time you'll receive a text we sent a notification to this url in a POST request.</p>
            </div>
            <div class="modal-body token token_3"> 
                <b><i class="zmdi zmdi-check-all" style="color: #26D367;"></i> Your API KEY was created.</b>
                <br>
                <input type="text"id="form_token_success" disabled autocomplete="false" style="border:1px solid #5AE4A8;margin:10px 0px"> 
                <button class="btn btn-green"id="copy_token" style="float: right;">Copy token</button>
                <p style="font-size: .8em;">Please save this secret key somewhere safe and accessible. For security reasons, you won't be able to view it again through your Chatter+ account. If you lose this secret key, you'll need to generate a new one.
                </p>
            </div>
            <div class="modal-footer token token_2 style="border:0px">
              <button type="button" class="btn" onclick="crear_token()">Send</button>
            </div>
            
            <div class="modal-footer token token_3 style="border:0px">
                <button type="button" class="btn" onclick="$('#tokenModal').modal('hide')">Close</button>
              </div>
          </div>
        </div>
    </div>

    <div class="modal" id="vincularModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Vincular dispositivo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body vincular vincular_1" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body vincular vincular_2" style="height:300px;font-weight:100;font-size:0.8em;display: none;">
                <input type="hidden" id="qr_nro">
                <center><div id="qr_wsp" style="text-align:center;border-radius: 5px;padding: 0px;margin-top: -10px;"></div>  </center>
            </div>
            <div class="modal-body vincular vincular_3" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div>
                <p>Connecting with your account...</p>
                </center>

            </div>
            <div class="modal-footer" style="border:0px">
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="alertModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title"><a class="nav-link" style="font-size:1em;margin-top: 0px;font-family: Square;">
                <b style="color:#f8f8f8">chAtter</b><b style="color: #5AE4A8">+</b></a></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="alertModal_body" style="font-weight:100;">
                
            </div>
            <div class="modal-footer" style="border:0px" id="alertModal_btn_div">
                <button class="btn" id="alertModal_btn" onclick=""></button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="textModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">Test your intance</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body textSend textSend_1" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body textSend textSend_2" style="font-weight:100;font-size:0.8em;display: none;">
                <input type="hidden" id="id_textSend">
                Send to: <br>
                <div style="margin-top: 10px;">
                <a class="btn btn_s_t" id="btn_contact" style="border-radius: 4px 0px 0px 4px;margin: 0px;" data="Contact">Contact</a><a class="btn btn_s_t" style="border-radius: 0px 0px 0px 0px;" data="Group">Group</a><a class="btn btn_s_t" style="border-radius: 0px 4px 4px 0px;" data="New">Other</a>
                </div>
                <select style="display: none;" placeholder="Phone number ej: +549....." id="tipo_textSend" onchange="if($(this).val()=='Group' || $(this).val()=='Contact'){$('#to_textSend').show();$('#to_textSend').val('');$('.to1_textSend').hide();}else{$('.to1_textSend').show();$('#to_textSend').hide();};if($(this).val()=='NO'){$('.to1_textSend').hide();$('.to_textSend').hide();}; if($(this).val()=='Group'){$('.contact_contact').hide();$('.contact_group').show();};if($(this).val()=='Contact'){$('.contact_contact').show();$('.contact_group').hide();};">
                    <option value="NO" style="color:#d4d4d4" disabled>Choose one</option>
                    <option value="Group">Group</option>
                    <option value="Contact">Contact</option>
                    <option value="New">Other</option>
                </select>
                <select placeholder="Phone number ej: +549....." id="to_textSend" style="margin-top: 10px;">
                </select>
                <div class="col-12 row to1_textSend" style="margin-top: 10px;">
                    <div class="col-5 ">
                        <select id="to1_textSend_country"></select>
                    </div>
                    <div class="col-7 p-0"><input type="text" placeholder="Phone number ej: +549....." id="to1_textSend"></div>
                </div>
                <textarea cols="30" rows="4" placeholder="Input your text here" id="text_textSend"></textarea>
                Add media: <br>
                <div style="margin-top: 10px;">
                <a class="btn btn_s_m" id="btn_no_media" style="border-radius: 4px 0px 0px 4px;margin: 0px;" data="false">No</a><a class="btn btn_s_m" style="border-radius: 0px 4px 4px 0px;" data="true">Yes</a>
                <input  style="width: 10px;display: none;" type="checkbox" value="" id="media_check" onchange="if($(this).prop('checked')){$('.media_textSend').show()}else{$('.media_textSend').hide()}">
                <div class="col-12 row media_textSend" style="margin-top: 10px;">
                    <div class="col-4 ">
                        <select id="media_type_textSend">
                            <option value="image">Image</option>
                            <option value="audio">Audio</option>
                            <option value="video">Video</option>
                            <option value="document">Document</option>
                        </select>
                    </div>
                    <div class="col-8 p-0">
                        <input type="text"  id="media_textSend" placeholder="Url of your media" autocomplete="off" >
                    </div>
                </div>
                
                </div>
                
                <p id="succ_msg"></p>
            </div>
            <div class="modal-footer" style="border:0px">
                <button class="btn" onclick="sendTextWsp()">Send text</button>
            </div>
          </div>
        </div>
    </div>
    <div class="modal" id="eliminarModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border:0px">
              <h5 class="modal-title">DELETE</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body eliminar eliminar_1" style="font-weight:100;font-size:0.8em;">
                <center><div class="lds-ring"><div></div><div></div><div></div><div></div></div></center>
            </div>
            <div class="modal-body eliminar eliminar_2" style="font-size:0.8em;display: none">
                <input type="hidden" id="eliminar_id">
                Are you sure about delete this instance?
            </div>
            <div class="modal-footer eliminar eliminar_2" style="border:0px">
                <button type="button" class="btn" onclick="eliminar_numero()">Delete</button>
            </div>
          </div>
        </div>
    </div>

    
  

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $("qs").on("click",function (e) {
        alertFun({text:$(this).attr("data")})
    })
    instancias=[];capa_actual=0
    function capa(i){
        $(".capa").hide();
        $('.menu').css("color",$(window).width() > 992?"#FFF":"#000")
        $('.menu').css("border-width","0px");
        $('.menu_'+i).css("border","0px solid #5AE4A8");;
        $('.menu_'+i).css("border-width","0px 0px 4px 0px");;
        $(".capa_"+i).show()
        capa_actual=i
    }
    $(".btn_s_t").on('click',function (){
        $('.btn_s_t').css('background','#333333');
        $(this).css('background','#5AE4A8');
        $("#tipo_textSend").val($(this).attr('data')).change()
    })
    $(".btn_s_m").on('click',function (){
        $('.btn_s_m').css('background','#333333');
        $(this).css('background','#5AE4A8');
        $("#media_check").attr('checked',$(this).attr('data')=="true"?true:false).change()
    })
   
    
    let eventQr=false;qrActual=""
    function checkQr(idI) {
        console.log("Check QR")
        console.log("checking")
        env={};
        env["token"]=user.token;
        env["instanceId"]=idI;
        ajax("/api/instance/get",env,(d)=>{
            const e=d.data;
            console.log("buscando", eventQr,e.instances[0].session,e)
            const newStatus=e.instances[0].session;
            switch (newStatus) {
                case 'connected':
                    $("#vincularModal").modal('hide');
                    buscar_phones();
                    break;
                case 'close':
                    eventQr=false;$("#vincularModal").modal('hide');
                    alertFun({text:"The Qr has expired. Try generating a new qr again",btn:"Ok"})
                    break;
                case 'connecting':
                    mostrar('vincular',3);
                    setTimeout(()=>{checkQr(idI);},1000); 
                    break;
                default:
                    console.log("buscando", eventQr,e.instances[0].session,e)
                    if(eventQr && newStatus=='qr')
                    {
                        newQr=e.instances[0].qr;
                        if(newQr!=$("#qr_value").val()){
                            mostrar('vincular',1);
                            setTimeout(() => {
                                mostrar('vincular',2);
                                crearQR(newQr,"qr_wsp");
                            }, 1000);
                        }
                        setTimeout(()=>{checkQr(idI);},1000); 
                    }
                break;
            }
        });
    }

    $("#vincularModal").on("hidden.bs.modal", function () {
       eventQr=false;
    });
    $("#vincularModal").on("shown.bs.modal", function () {
       eventQr=true;
    });

    function sendTextWsp(){
        env={};
        env["token"]=user.token;
        media=$("#media_check").prop('checked');
        media?tipo="caption":tipo="message"
        env["instanceId"]=$("#id_textSend").val();
        env["remoteJid"]=$("#to_textSend").val();
        if($("#tipo_textSend").val()=="New"){
            env["remoteJid"]=$("#to1_textSend_country").val()+$("#to1_textSend").val()+"@s.whatsapp.net";    
        }
        env[tipo]=$("#text_textSend").val();
        env["fileUrl"]=$("#media_textSend").val();
        env["type"]=$("#media_type_textSend").val();;
        env["document"]=true;
        console.log(env)
        mostrar('textSend',1);
        ajax(media?"/api/instance/sendmedia":"/api/instance/send",env,(d)=>{
            const e=d.data
            mostrar('textSend',2);
            $("#text_textSend").val("");
            $('#succ_msg').append('<i class="zmdi zmdi-check-all" style="color:#5AE4A8"></i>Message succesful.');
            setTimeout(()=>{$("#succ_msg").html("")},1500)
        },(d)=>{
            problema=analisis_error(d,true)
            mostrar('textSend',2);
            $('#succ_msg').append('<i class="zmdi zmdi-close" style="color:red"></i>'+problema);
            setTimeout(()=>{$("#succ_msg").html("")},3000)
            return true;
        })
    }

    const sent_email_valid=()=>{
        env={};
        env["token"]=user.token;
        capa(0)
        ajax("/login/users/sendvalidation",env,(d)=>{
            capa(100);
            if(d.status==200){alertFun({text:`We have sent an email. Don't forget to check you spam.`,btn:`Ok`,functionModal:()=>{$("#alertModal").modal('hide');}});}
            
        },(d)=>{
            analisis_error(d);
            capa(2);
            return true;
        });
    }

    const sent_edit_user=()=>{
        env={};
        env["token"]=user.token;
        env["uid"]=user.user.uid;
        env["name"]=$("#name_form_user").val();
        env["email"]=$("#email_form_user").val();
        capa(0)
        ajax("/login/users/edit",env,(d)=>{
            user.user=d.data.user;
            localStorage.setItem("user",JSON.stringify(user));
            control_sesion(false)
            capa(3)
        },(d)=>{
            analisis_error(d);
            capa(3);
            return true;
        });
    }
    
    
    const buscar_phones=(spiner=true)=>{
        mostrar('user',2)
        if(spiner){
        capa(0)
        }
        env={};
        env["token"]=user.token;
        ajax("/api/instance/get",env,(d)=>{
            const e=d.data;
            $("#div_phones").html("")
            capa(2)
            if(e.length==0)
            {
                $("#div_phones").html(`
                <center>
                <p style='font-size:1.7em;text-align:center;margin-top:50px'><i class='zmdi zmdi-mood-bad' style='color:#26D367'></i> You don't have intances!</p>
                <button class='btn btn-sm' onclick='$("#btn_new_intance").click()'>Create your first intance</button>
                </center>`);
                return true;
            }
            
            init=false
            instancias=e.instances;
            e.instances.forEach((b,i) => {
                $nros="";
                b.session=='initializing'?init=true:false;
                html=`<div class="col-12" style="padding:4px 0px">
                    <div class="col-12 placa" style="cursor:default">
                        <button class="btn btn3" data="${b.instanceId}" onclick="eliminar_numero_modal($(this).attr('data'),'eliminado')" ><img src="assets/img/delete.png" style="height:14px"></button>
                        <button class="btn btn3" data="${b.instanceId}" onclick="editar_numero($(this).attr('data'))" ><img src="assets/img/settings.png" style="height:15px"></button>
                        <div style="display:${b.session=='close' || b.session=='qr'?'block':'none'}">
                            <h3 style="margin:5px 0px;font-size:.7em"><a style="color:#5AE4A8">ID</a> ${b.instanceId || "No name"} <a style="color:#5AE4A8">Name</a> ${b.name || "No name"}</h3>
                            <p style="font-size:.8em;margin:0px 0px 0px 0px"><i class="zmdi zmdi-alert-triangle" style="color:#FFCC00"></i>
                                Disconnected. <button class="btn btn3" data="${b.instanceId}" style="font-size:.8em;float:inherit;background:#5AE4A8;color:#000;padding:2px 7px"  onclick="solicitar_qr('${b.instanceId}')"><img src="assets/img/qr.png" style="height:12px;margin-top:-2px;filter:invert(0)"> Connect now</button>
                            </p>
                        </div>
                        <div style="display:${b.session=='connected'?'block':'none'}"">
                            <h3 style="margin:5px 0px;font-size:.7em"><a style="color:#5AE4A8">ID</a> ${b.instanceId || "No name"} <a style="color:#5AE4A8">Name</a> ${b.name || "No name"}</h3>
                            <h5 style='margin:0px 0px 0px 0px;font-weight:100;display:${b.session=='connected'?'block':'none'}'>${b.number||""}</h5>
                            <p style="font-size:.8em;margin:0px"><img src="./assets/img/check.png" style="width:14px"> Connected</p>
                            <div style="height:30px;margin-top:10px">
                                <button class="btn btn3" data="${b.instanceId}" style="font-size:.7em;float:left" onclick="$('#textModal').modal('show');$('#tipo_textSend').val('NO');$('#btn_contact').click();$('#btn_no_media').click();mostrar('textSend',2);$('#id_textSend').val($(this).attr('data'));checkContacts()" ><img src="assets/img/send.png" style="height:12px;margin-top:-2px"> Send text</button>
                            </div>
                        </div>
                        <div style="font-size:.8em;display:${b.session=='initializing'?'block':'none'}"">
                            <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> Starting instance
                        </div>
                        <div id="connection_${b.nro}">
                        </div>
                    </div>
                </div>`
                $("#div_phones").append(html);
                actualizar_connection(b.nro,b.connection)  
            });
            if(init){
                setTimeout(()=>{buscar_phones(false);},1000)
                
            }
        },(d)=>{
            capa(2);
            analisis_error(d);
            return true;
        })
    }

    function checkContacts(){
        env={};
        env["token"]=user.token;env["instanceId"]= $('#id_textSend').val();
        $("#to_textSend").html('')
        ajax("/api/instance/contacts",env,(d)=>{
            const e=d.data;
            e.contacts=e.contacts.map( a=> {return {id:a.id,name:a.name?a.name:a.notify}});
            e.contacts.sort((a, b) => {
                // Convertir ambos nombres a minúsculas para una comparación sin distinción entre mayúsculas y minúsculas
                const nameA = a.name?.toLowerCase();
                const nameB = b.name?.toLowerCase();

                // Comparar los nombres y devolver el resultado de la comparación
                if (nameA < nameB) {
                    return -1; // Si el nombre de 'a' es menor que el nombre de 'b', devuelve un número negativo
                }
                if (nameA > nameB) {
                    return 1; // Si el nombre de 'a' es mayor que el nombre de 'b', devuelve un número positivo
                }
                return 0; // Si los nombres son iguales, devuelve 0
            });
            e.contacts.forEach(x => {
                const c=x;
                $("#to_textSend").append(`<option value="${c.id}" class="${c.id?.indexOf('@g.us')>-1?"contact_group":"contact_contact"}">${c.name|| c.notify} (${c.id})</option>`)
            });
        },(d)=>{
            $('#textModal').modal('hide');
            analisis_error(d)
            return;
        })
    }

    

    function actualizar_connection(nro,connection){
        $("#connection_"+nro).html(`
        
        <p style="font-size:.7em;margin:0px;display:${connection=='online'?'block':'none'}"><img src="img/active.png" width="20">CONECTADO</p>
        <p style="font-size:.7em;margin:0px;display:${connection=='inicializando'?'block':'none'}"><img src="img/init.gif" style="width:15;margin:0px 4px">CONECTANDO..</p>
        <p style="font-size:.7em;margin:0px;display:${connection=='stop'?'block':'none'}"><img src="img/desactive.png" style="width:15px;margin:0px 4px">DESCONECTADO</p>
        <p style="font-size:.7em;margin:0px;display:${connection=='qr'?'block':'none'}"><img src="assets/img/qr.png" style="width:15px;margin:0px 4px">DESVINCULADO <button class="btn sombra"  onclick="$('#qr_nro').val('${nro}');mostrar('vincular',1);$('#vincularModal').modal('show')" style="background:#FFF;padding:3px 5px;font-size:.8em;margin:0px;margin-top:0px"> Vincular</button></p>
        `)
    }

    function mostrar(capa,i){
        $("."+capa).hide();
        $("."+capa+"_"+i).show();
    }
    
    function crearQR(data,divId){
        const qrCode = new QRCodeStyling({
            width: 250,
            height: 250,
            type: "svg",
            data,
            image: "assets/img/base.png",
            dotsOptions: {
                color: "#FFF",
                type: "rounded"
            },
            backgroundOptions: {
                color: "#28282800",
            },
            imageOptions: {
                crossOrigin: "anonymous",
                margin: 1
            }
        });
        $('#'+divId).html(`<input type="hidden" id="qr_value" value="${data}">`)
        qrCode.append(document.getElementById(divId));
    }

    function open_phone_modal(){
        mostrar('create',2);
        $('.radio_input').prop('disabled',false);
        $("#nuevo_type_wsp_"+1).prop('checked',true);
        $('.radio_input_div').css('color','#FFF');
        $('#phoneModal').modal('show');
        $('.nuevo_wsp').val('')
        if(user.user.plan==2)return true;
        $("#nuevo_type_wsp_"+1).parent().css("color","#333")
        $("#nuevo_type_wsp_"+1).prop('disabled',true);
        $("#nuevo_type_wsp_"+3).prop('checked',true);
    }
    

    function editar_numero(id) {
        $("#phoneModal").modal('show');
        mostrar('create',2);
        instancia=instancias.find(a=>a.instanceId==id)
        $("#nuevo_nro_wsp").val(instancia.name);
        $("#nuevo_id_wsp").val(instancia.instanceId);
        $("#nuevo_webhook_wsp").val(instancia.webhook)
        type=["full","trial","free"];
        s=type.findIndex(a=>a==instancia.type)+1
        $("#nuevo_type_wsp_"+s).prop("checked",true)
        $(".radio_input").prop("disabled",true)
        $(".radio_input_div").css("color","#333")
        $("#nuevo_type_wsp_"+s).parent().css("color","#FFF")
    }

    function editar_numero_tel(){
        env={}
        env.name=$("#nuevo_nro_wsp").val();
        env.webhook=$("#nuevo_webhook_wsp").val();
        env.instanceId=$("#nuevo_id_wsp").val();
        env.token=user.token
        mostrar('create',1)
        ajax("/api/instance/edit",env,(d)=>{
            const e=d.data;
            $("#phoneModal").modal('hide');
            buscar_phones(true);
        },(d)=>{
            analisis_error(d);
            $("#phoneModal").modal('hide');
        })
    }

    function agregar_numero_tel(){
        nro=$("#nuevo_nro_wsp").val()
        env={}
        env.name=nro;env.token=user.token;
        s=$("input[type='radio']:checked").prop("id").split("_")[3];
        type=["full","trial","free"];
        env.type=type[s-1]
        mostrar('create',1)
        ajax("/api/instance/create",env,(d)=>{
            const e=d.data;
            $('#form_create_success').val(e.instance.instanceId);
            mostrar('create',3)
            buscar_phones();
        },(d)=>{
            text=analisis_error(d,true);
            $("#create_problem").html(text);
            mostrar('create',2)
        })
    }

    function buscar_token(show){
        env={};
        if(show){capa(0)}
        env["token"]=user.token;env["instanceId"]= $('#id_textSend').val();
        $("#div_tokens").html('')
        ajax("/login/users/getapitoken",env,(d)=>{
            const e=d.data;
            e.tokens.forEach((b,i) => {
                $("#div_tokens").append(`<div class="col-12" style="padding:4px 0px">
                    <div class="col-12 placa" style="cursor:default">
                        <button class="btn btn3" data="${b.id}" onclick="edit_token($(this).attr('data'),'deleted')" ><img src="assets/img/delete.png" style="height:14px"></button>
                        <div>
                            <h3 style="margin:5px 0px;font-size:.7em"><a style="color:#5AE4A8">API KEY NAME: </a> ${b.name || "No name"}</h3>
                            <h3 style="margin:5px 0px;font-size:.7em"><a style="color:#5AE4A8">Status: </a> ${b.status=="active"?'working':'pause'}</h3>
                            <button class="btn btn-green" style="padding:0px 12px;float:left;border:1px solid ${b.status=="active"?' #5AE4A8':'#333'};background:#535353" data="${b.id}" onclick="edit_token($(this).attr('data'),'active')" ><i class='zmdi zmdi-play' style="color:#FFF"></i></button>
                            <button class="btn btn-green" style="padding:0px 12px;float:left;border:1px solid ${b.status!="active"?' #5AE4A8':'#333'};background:#535353" data="${b.id}" onclick="edit_token($(this).attr('data'),'paused')" ><i class="zmdi zmdi-pause" style="color:#FFF"></i></button>
                            <hr style="border:0px">
                        </div>
                    </div>
                </div>`);
                actualizar_connection(b.nro,b.connection)  
                
            });
            if(show){capa(4)}
        })
    }
    
    function crear_token(){
        name=$("#nuevo_name_token").val()
        env={}
        env.name=name;env.token=user.token;
        mostrar('token',1)
        ajax("/login/users/apitoken",env,(d)=>{
            const e=d.data;
            $('#form_token_success').val(e.token);
            mostrar('token',3)
            buscar_token();
        },(d)=>{
            analisis_error(d);
            mostrar('token',2)
            return false;
        })
    }
    
    function edit_token(tokenId,status){
        env={tokenId,status};
        env.token=user.token;
        ajax("/login/users/editapitoken",env,(d)=>{
            const e=d.data;
            buscar_token(true);
        },(d)=>{
            analisis_error(d);
            return false;
        })
    }

    function solicitar_qr_init(){
        solicitar_qr($("#form_create_success").val());
        $('#phoneModal').modal('hide');
    }

    function solicitar_qr(idI){
        mostrar('vincular',1)
        $('#vincularModal').modal('show');
        env={}
        env.instanceId=idI;env.token=user.token;
        ajax("/api/instance/init",env,(d)=>{
            const e=d.data;
            if(e.instance.qr!=""){
                mostrar('vincular',2)
                crearQR(e.instance.qr,"qr_wsp");
                checkQr(idI)
            }else{
                setTimeout(()=>{solicitar_qr(idI);},1400)
            }
        },(d)=>{
            analisis_error(d);
            return false;
        })
    }
    

    function eliminar_numero(){
        env={}
        env.instanceId=$("#eliminar_id").val();env.token=user.token;
        mostrar('eliminar',1)
        ajax("/api/instance/delete",env,(d)=>{
            const e=d.data;
            $("#eliminarModal").modal('hide');
            buscar_phones()            
        },(e)=>{
            analisis_error(e)
            $("#eliminarModal").modal('hide');
            return false;
        })
    }

    function eliminar_numero_modal(idI){
        $("#eliminarModal").modal('show');
        mostrar('eliminar',2)  
        $("#eliminar_id").val(idI)
    }

    

    function ajax(url,json_dat,callback,error=function(e) {console.log("ERRROR",e)}){
            let token="Bearer"
            if(json_dat?.token){
                 token=`Bearer ${json_dat.token}`
            }
            //console.log("token",token)
            $.ajax({url,type:"POST",headers: {"Content-Type": "application/json","Authorization": token},dataType : 'json',data: JSON.stringify(json_dat),success: function(data, textStatus, jqXHR){callback(data)},error: function( jqXHR, textStatus, errorThrown ) {error(jqXHR.responseJSON);}});
    }

    $("#nro").on('keyup',(e)=>{
        if(e.keyCode==13){add_nro();}
    })

    function add_nro(){
        nros=$("#nro").val().split(";");
        nros.forEach(nro => {
            if(nro==""){return}
            $("#div_nro").append(`
            <b class="btn nroSaved" data="${nro}" style="margin-top:4px;border:1px solid grey;padding:1px 5px">${nro} <a onclick="$(this).parent().remove()" style="font-weight:100;font-size:1.2em"><i class="zmdi zmdi-close-circle-o"></i></a></b>
            `);
        });
        $("#nro").val("")
    }

    function capa103animation(){
        $('.check').css('animation', 'start 1s ease both');
        setTimeout(function() {
        $('.animated-text').addClass('typing');
        }, 1000);
        setTimeout(function() {
        $("#btn-animation").show()
        }, 2000);
    }

    
    
    mostrar('user',2)
    let user;
    $(window).on('load',()=>{
        fillConsumption()
        mostrar('user',1)
        const token=getParameterByName("token")
        if(token){
            var newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({ path: newUrl }, '', newUrl);
            checktoken(token)
        }else{
            user=JSON.parse(localStorage.getItem("user")|| "{}")
            if(user.token){
                checktoken(user.token)
            }else{
                localStorage.clear();location.href="index.html";
            }
        }
        //alert(token)
    })

    //Cuando se hace un chequeo del email se inicia sesión con un token y hay que validarlo.
    function checktoken(token,id){
        env={token};
        ajax("/login/users/check",env,(d)=>{
            const e=d.data;
            localStorage.setItem("user",JSON.stringify(e))
            user=JSON.parse(localStorage.getItem("user")|| "{}")
            control_sesion();
        },(d)=>{
            analisis_error(d)
            return;
        })
    }
    
    function control_sesion(buscar=true){
        if(user){
            $("#account_name").html(user.user.nombre);
            $("#name_form_user").val(user.user.nombre)
            $("#email_form_user").val(user.user.correo)
            if(!user.user.password){
                open_pass_modal(false)
                return true;
            }
            if(user.user.plan==0){
                mostrar('user',1);
                capa(101);
                $(".btn_back_plan").hide()
                return true;
            }
            if(user.user.email_valid){
                $("#email_valid_form_user_check").show()
            }
            if(!user.user.email_valid){
                $("#email_valid_form_user").show();
                $("#email_valid_form_user_uncheck").show();
                mostrar('user',1);
                capa(100)
                return true;
            }
            $(".user").css("background","none")
            $(".plan_form_user").hide()
            $(".plan_form_user_"+user.user.plan).show()
            mostrar('user',2)
            capa(2)
            if(buscar){
                buscar_phones();
                buscar_token();
                getCards()
                pending_charges()
                fetchPayment()
                buscar_consumptions()

            }
        }
    }

    function fillConsumption(){
        mes=new Date().getMonth()+1
        anio=new Date().getFullYear()
        for(x=0;x<12;x++){
            $("#consumption_month").append(`<option value="${x+1}" style="background:#535353">${x+1}</option>`)
            $("#consumption_year").append(`<option value="${anio-x}" style="background:#535353">${anio-x}</option>`)    
        }
        $("#consumption_month").val(mes)
        $("#consumption_year").val(anio)
    }

    function buscar_consumptions(){
        env={};env["token"]=user.token;
        env.month=$("#consumption_month").val()
        env.year=$("#consumption_year").val()
        ajax("/api/instance/consumptions",env,(d)=>{
            const e=d?.data;
            $("#consumptions").html("")
            $("#total_consumptions").html("")
            $("#estimate").remove()
            if(e.instancesData?.actual || e.instancesData?.future){
                $("#consumptions").after(`
                <p id="estimate">Monthly estimate: ${e?.instancesData?.resume.estimatedConsumption.toFixed(2)}</p>
                `)
            }
            if(!e.instancesData?.future){$("#total_consumptions").html(e?.instancesData?.resume.consumption.toFixed(2)+" Instances")}
        },(d)=>{
            problema=analisis_error(d,true)
            return true;
        })

    }

    function fecha(fc,seg){
        fc=new Date(fc);
        ms=fc.getMonth()+1;ms<10?ms="0"+ms:true;
        d=fc.getDate();d<10?d="0"+d:true;
        h=fc.getHours();h<10?h="0"+h:true;
        m=fc.getMinutes();m<10?m="0"+m:true;
        s="";if(seg){s=fc.getSeconds();s<10?s="0"+s:true;s=":"+s;}
        return h+":"+m+s+" "+d+"/"+ms+"/"+fc.getFullYear();
    }

    $(".capa").hide()
    mostrar('user',2)
    

    function open_pass_modal(newPass){
        capa(102);mostrar('user',1)
        $("#new_password_1").val("");$("#new_password_2").val("");$("#old_password").val("");
        $("#new_password_alert").html("")
        mostrar('pass',2)
        if(!newPass){
            $(".title_pass").html("Set a password to continue")
            $(".old_pass").hide()
        }else{
            $(".old_pass").show()
            $(".title_pass").html("Set new password")
        }

    }

    function set_password(){ 
        problema=""
        if($("#new_password_1").val().length<6){problema+="Passwords must be at least 6 characters.<br>"}
        if($("#new_password_1").val()!=$("#new_password_2").val()){problema+="Passwords must match.<br>"}
        $("#new_password_alert").html(problema);
        if(problema!=""){return;}
        env={};
        if($(".old_pass").eq(0).css("display")!="none"){
            env["password"]=$("#old_password").val();
        }
        env["newPassword"]=$("#new_password_1").val();
        env["token"]=user.token;
        capa(0)
        ajax("/login/users/setpassword",env,(d)=>{
            if(d.status==400){
                capa(102);
                $("#new_password_alert").html(d.message)
                return;
            }
            checktoken(user.token);
        });
    }
    
    chargesSelected=[];
        async function pending_charges(){
            chargesSelected=[];
            $("#charges").html(`<center>Loading your pending payments...</center>`)
            ajax('/payment/pendingcharges',{token:user.token},(response)=>{
                    const {charges:data}=response
                    total=0; 
                    $("#charges").html("")
                    data.forEach((e,i) => {
                        chargesSelected.push({amount:e.amount,id:e._id,selected:true})
                        total+=e.amount;
                        $("#charges").append(`
                        <div class="col-12" style="padding:4px 0px">
                            <div class="col-12" style="color:#FFF;background:rgb(255,255,255,.1);padding:10px;text-align:left;border-radius:10px">
                                <a style="float:right">u$d ${e.amount/100}</a>
                                <div class="form-check" style="width:20px;height:15px;padding:0px;float:left;margin:0px">
                                <input class="checkPending" style="margin:0px;padding:0px" type="checkbox" onchange="chargesSelected[${i}].selected=$(this).prop('checked');sumSelect()" checked>
                                </div>${e.title} 
                                <p style="font-size:.7em;margin:0px">Created: ${formatDate(e.created)}</p>
                                <p style="font-size:.7em;margin:0px">Pay before: ${formatDate(e.dueDate)}</p> 
                                <p style="font-size:.7em;margin:0px">Status: ${e.status.toUpperCase()}</p> 
                            </div>
                        </div>    
                        `)
                    });
                    $("#totalAmount").html("u$d "+(total/100).toFixed(2))
                    if(data.length==0){
                            $("#charges").html(`<p>No pending payments</p>`)
                            $(".btn_pay_now").hide()
                    }
                    sumSelect()
            },(d)=>{
                console.log("error:",d);
                return false;
            });
        }

        async function sumSelect(){
            total=0;
            chargesSelected.forEach(e => {
               if(e.selected) total+=e.amount;
            });
            $("#totalAmountPay").html("u$d "+(total/100).toFixed(2))
            const a=chargesSelected.map(a=>{return a.selected?a.id:undefined}).filter(a=>a)
        }
        

        async function paySum(){
            if($("#cardOption").val()=="NO"){
                $("#payNow_problem").html("You must choose a card.");
                setTimeout(() => {
                    $("#payNow_problem").html("")
                }, 2000);
                return true;
            }
            mostrar('payDiv',1);
            const chargeIds=chargesSelected.map(a=>{return a.selected?a.id:undefined}).filter(a=>a)
            const amount = chargesSelected.reduce((total, obj) => obj.selected ? total + obj.amount : total, 0);
            const paymentMethodId=paymentMethod_default;
            const env={ paymentMethodId, amount ,chargeIds , token:user.token};
            ajax('/payment/chargecustomer',env,(response)=>{
                    if(response.success){
                    pending_charges()
                    fetchPayment();
                        mostrar('payDiv',3);
                    }else{
                        $("#payNow_problem").html("Error: Payment failed. Try again or use another card.");
                        setTimeout(() => {
                            $("#payNow_problem").html("")
                        }, 3000);
                        mostrar('payDiv',2)
                    }
            });
        }

        async function fetchPayment(){
            $("#payments").html(`<center>Loading your payments...</center>`)
            ajax('/payment/userPayments',{token:user.token},(response)=>{
                    const {payments:data}=response
                    total=0; 
                    $("#payments").html(``)
                    data.forEach((e,i) => {
                        $("#payments").append(`
                        <div class="col-12" style="padding:4px 0px">
                            <div class="col-12" style="color:#FFF;background:rgb(255,255,255,.1);padding:10px;text-align:left;border-radius:10px">
                                ${formatDate(e.created)}
                                <a style="float:right">u$d ${e.amount/100}</a>
                            </div>
                        </div>    
                        `)
                    });
                    $("#totalAmount").html("u$d "+(total/100).toFixed(2))
                    if(data.length==0){
                            $("#payments").html(`No registered payments`)
                    }
                    sumSelect()
                });
        }

      
        
    $(".btn_start").on("click",function(){
        env={};
        const initPlan=user.user.plan;
        env["plan"]=$(this).attr("data");
        env["uid"]=user.user.uid;
        env["token"]=user.token;
        capa(0)
        ajax("/login/users/edit",env,(d)=>{
            user.user=d.data.user;
            localStorage.setItem("user",JSON.stringify(user));
            if(initPlan==0){
                mostrar('user',1);
                capa(103);
                capa103animation()
                return
            }
            mostrar('user',2);
            capa(2)
        });
    
    })
    
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function alertFun({text,btn="OK",functionModal=()=>{$("#alertModal").modal('hide');}}) {
        $("#alertModal").modal('show')
        $("#alertModal_body").html(text);
        if(btn){
            $("#alertModal_btn_div").show();
            $("#alertModal_btn").html(btn);
            $("#alertModal_btn").on('click',functionModal)
        }else{
            $("#alertModal_btn_div").hide();
        }
    }

    const analisis_error=(d,reverse)=>{
        text=d.message;
        if(d?.data?.errors){
            if(d.data.errors[0]?.msg.indexOf("Invalid token")>=0){localStorage.clear();location.href="index.html";}
            d.data.errors.forEach((a,i)=>{
                text+=`<br>${i+1}) ${a.msg}.`
            })
        }
        if(reverse){return text}
        alertFun({text});
        return false;
    }


</script>
  <script>
    $(document).ready(function(){
      const panel=$("#navbar_container").html();
      function alertOnDesktop(){
        if($(window).width() > 992){ // Tamaño para computadora (puedes ajustar el valor según tus necesidades)
            $("#nav_lat").html(panel)
            $("#navbar_container").html("")
            $("#nav_lat").css("padding","20px 10px")
        }else{
            $("#nav_lat").html("")
            $("#navbar_container").html(panel)
            $('.navbar-panel').mtrPanel({toggle: '.menu-toggle'});
        }
        capa(capa_actual)
        $("iframe").height($(window).height()-$(".fixed-top").height()-6)
      }
      alertOnDesktop(); // Llamada inicial
      
      $(window).resize(function(){
        alertOnDesktop(); // Llamada cuando cambia el tamaño de la pantalla
      });
      var $scrollContainer = $('.carrusel');
      var scrollWidth = $scrollContainer.get(0).scrollWidth;
      var containerWidth = $scrollContainer.width();
      var scrollLeft = (scrollWidth - containerWidth) / 2;
      $scrollContainer.scrollLeft(scrollLeft);
    });

    const formatDate = (timestamp) => {
            const date = new Date(timestamp * 1000); // Convertir de segundos a milisegundos

            const year = date.getFullYear();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth()+1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}`;
        };
    

    paises={
    "countries": [
        {"country": "Afghanistan", "code": "93"},
        {"country": "Albania", "code": "355"},
        {"country": "Algeria", "code": "213"},
        {"country": "Andorra", "code": "376"},
        {"country": "Angola", "code": "244"},
        {"country": "Argentina", "code": "549"},
        {"country": "Armenia", "code": "374"},
        {"country": "Australia", "code": "61"},
        {"country": "Austria", "code": "43"},
        {"country": "Azerbaijan", "code": "994"},
        {"country": "Bahamas", "code": "1242"},
        {"country": "Bahrain", "code": "973"},
        {"country": "Bangladesh", "code": "880"},
        {"country": "Barbados", "code": "1246"},
        {"country": "Belarus", "code": "375"},
        {"country": "Belgium", "code": "32"},
        {"country": "Belize", "code": "501"},
        {"country": "Benin", "code": "229"},
        {"country": "Bhutan", "code": "975"},
        {"country": "Bolivia", "code": "591"},
        {"country": "Bosnia and Herzegovina", "code": "387"},
        {"country": "Botswana", "code": "267"},
        {"country": "Brazil", "code": "55"},
        {"country": "Brunei", "code": "673"},
        {"country": "Bulgaria", "code": "359"},
        {"country": "Burkina Faso", "code": "226"},
        {"country": "Burundi", "code": "257"},
        {"country": "Cabo Verde", "code": "238"},
        {"country": "Cambodia", "code": "855"},
        {"country": "Cameroon", "code": "237"},
        {"country": "Canada", "code": "1"},
        {"country": "Central African Republic", "code": "236"},
        {"country": "Chad", "code": "235"},
        {"country": "Chile", "code": "56"},
        {"country": "China", "code": "86"},
        {"country": "Colombia", "code": "57"},
        {"country": "Comoros", "code": "269"},
        {"country": "Congo (Congo-Brazzaville)", "code": "242"},
        {"country": "Congo (DRC)", "code": "243"},
        {"country": "Costa Rica", "code": "506"},
        {"country": "Croatia", "code": "385"},
        {"country": "Cuba", "code": "53"},
        {"country": "Cyprus", "code": "357"},
        {"country": "Czech Republic", "code": "420"},
        {"country": "Denmark", "code": "45"},
        {"country": "Djibouti", "code": "253"},
        {"country": "Dominica", "code": "1767"},
        {"country": "Dominican Republic", "code": "1"},
        {"country": "Ecuador", "code": "593"},
        {"country": "Egypt", "code": "20"},
        {"country": "El Salvador", "code": "503"},
        {"country": "Equatorial Guinea", "code": "240"},
        {"country": "Eritrea", "code": "291"},
        {"country": "Estonia", "code": "372"},
        {"country": "Eswatini", "code": "268"},
        {"country": "Ethiopia", "code": "251"},
        {"country": "Fiji", "code": "679"},
        {"country": "Finland", "code": "358"},
        {"country": "France", "code": "33"},
        {"country": "Gabon", "code": "241"},
        {"country": "Gambia", "code": "220"},
        {"country": "Georgia", "code": "995"},
        {"country": "Germany", "code": "49"},
        {"country": "Ghana", "code": "233"},
        {"country": "Greece", "code": "30"},
        {"country": "Grenada", "code": "1473"},
        {"country": "Guatemala", "code": "502"},
        {"country": "Guinea", "code": "224"},
        {"country": "Guinea-Bissau", "code": "245"},
        {"country": "Guyana", "code": "592"},
        {"country": "Haiti", "code": "509"},
        {"country": "Honduras", "code": "504"},
        {"country": "Hungary", "code": "36"},
        {"country": "Iceland", "code": "354"},
        {"country": "India", "code": "91"},
        {"country": "Indonesia", "code": "62"},
        {"country": "Iran", "code": "98"},
        {"country": "Iraq", "code": "964"},
        {"country": "Ireland", "code": "353"},
        {"country": "Israel", "code": "972"},
        {"country": "Italy", "code": "39"},
        {"country": "Jamaica", "code": "1876"},
        {"country": "Japan", "code": "81"},
        {"country": "Jordan", "code": "962"},
        {"country": "Kazakhstan", "code": "7"},
        {"country": "Kenya", "code": "254"},
        {"country": "Kiribati", "code": "686"},
        {"country": "Kuwait", "code": "965"},
        {"country": "Kyrgyzstan", "code": "996"},
        {"country": "Laos", "code": "856"},
        {"country": "Latvia", "code": "371"},
        {"country": "Lebanon", "code": "961"},
        {"country": "Lesotho", "code": "266"},
        {"country": "Liberia", "code": "231"},
        {"country": "Libya", "code": "218"},
        {"country": "Liechtenstein", "code": "423"},
        {"country": "Lithuania", "code": "370"},
        {"country": "Luxembourg", "code": "352"},
        {"country": "Madagascar", "code": "261"},
        {"country": "Malawi", "code": "265"},
        {"country": "Malaysia", "code": "60"},
        {"country": "Maldives", "code": "960"},
        {"country": "Mali", "code": "223"},
        {"country": "Malta", "code": "356"},
        {"country": "Marshall Islands", "code": "692"},
        {"country": "Mauritania", "code": "222"},
        {"country": "Mauritius", "code": "230"},
        {"country": "Mexico", "code": "52"},
        {"country": "Micronesia", "code": "691"},
        {"country": "Moldova", "code": "373"},
        {"country": "Monaco", "code": "377"},
        {"country": "Mongolia", "code": "976"},
        {"country": "Montenegro", "code": "382"},
        {"country": "Morocco", "code": "212"},
        {"country": "Mozambique", "code": "258"},
        {"country": "Myanmar", "code": "95"},
        {"country": "Namibia", "code": "264"},
        {"country": "Nauru", "code": "674"},
        {"country": "Nepal", "code": "977"},
        {"country": "Netherlands", "code": "31"},
        {"country": "New Zealand", "code": "64"},
        {"country": "Nicaragua", "code": "505"},
        {"country": "Niger", "code": "227"},
        {"country": "Nigeria", "code": "234"},
        {"country": "North Macedonia", "code": "389"},
        {"country": "Norway", "code": "47"},
        {"country": "Oman", "code": "968"},
        {"country": "Pakistan", "code": "92"},
        {"country": "Palau", "code": "680"},
        {"country": "Palestine", "code": "970"},
        {"country": "Panama", "code": "507"},
        {"country": "Papua New Guinea", "code": "675"},
        {"country": "Paraguay", "code": "595"},
        {"country": "Peru", "code": "51"},
        {"country": "Philippines", "code": "63"},
        {"country": "Poland", "code": "48"},
        {"country": "Portugal", "code": "351"},
        {"country": "Qatar", "code": "974"},
        {"country": "Romania", "code": "40"},
        {"country": "Russia", "code": "7"},
        {"country": "Rwanda", "code": "250"},
        {"country": "Saint Kitts and Nevis", "code": "1869"},
        {"country": "Saint Lucia", "code": "1758"},
        {"country": "Saint Vincent and the Grenadines", "code": "1784"},
        {"country": "Samoa", "code": "685"},
        {"country": "San Marino", "code": "378"},
        {"country": "Sao Tome and Principe", "code": "239"},
        {"country": "Saudi Arabia", "code": "966"},
        {"country": "Senegal", "code": "221"},
        {"country": "Serbia", "code": "381"},
        {"country": "Seychelles", "code": "248"},
        {"country": "Sierra Leone", "code": "232"},
        {"country": "Singapore", "code": "65"},
        {"country": "Slovakia", "code": "421"},
        {"country": "Slovenia", "code": "386"},
        {"country": "Solomon Islands", "code": "677"},
        {"country": "Somalia", "code": "252"},
        {"country": "South Africa", "code": "27"},
        {"country": "South Korea", "code": "82"},
        {"country": "South Sudan", "code": "211"},
        {"country": "Spain", "code": "34"},
        {"country": "Sri Lanka", "code": "94"},
        {"country": "Sudan", "code": "249"},
        {"country": "Suriname", "code": "597"},
        {"country": "Sweden", "code": "46"},
        {"country": "Switzerland", "code": "41"},
        {"country": "Syria", "code": "963"},
        {"country": "Taiwan", "code": "886"},
        {"country": "Tajikistan", "code": "992"},
        {"country": "Tanzania", "code": "255"},
        {"country": "Thailand", "code": "66"},
        {"country": "Timor-Leste", "code": "670"},
        {"country": "Togo", "code": "228"},
        {"country": "Tonga", "code": "676"},
        {"country": "Trinidad and Tobago", "code": "1868"},
        {"country": "Tunisia", "code": "216"},
        {"country": "Turkey", "code": "90"},
        {"country": "Turkmenistan", "code": "993"},
        {"country": "Tuvalu", "code": "688"},
        {"country": "Uganda", "code": "256"},
        {"country": "Ukraine", "code": "380"},
        {"country": "United Arab Emirates", "code": "971"},
        {"country": "United Kingdom", "code": "44"},
        {"country": "United States", "code": "1"},
        {"country": "Uruguay", "code": "598"},
        {"country": "Uzbekistan", "code": "998"},
        {"country": "Vanuatu", "code": "678"},
        {"country": "Vatican City", "code": "39"},
        {"country": "Venezuela", "code": "58"},
        {"country": "Vietnam", "code": "84"},
        {"country": "Yemen", "code": "967"},
        {"country": "Zambia", "code": "260"},
        {"country": "Zimbabwe", "code": "263"}
    ]
    }
    paises_html=""
    paises.countries.forEach(e => {
        paises_html+=`<option value="${e.code}">${e.country} (+${e.code})</option>`
    });
    $("#to1_textSend_country").html(paises_html)

    $("#copy_token").on('click',function(){
        var copyText = document.getElementById("form_token_success");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
    })

    styleStipe={
            style: {
                base: {
                    color: 'white', // Texto blanco en el campo de la tarjeta
                    '::placeholder': {
                        color: '#888' // Color del texto del placeholder
                    },
                    backgroundColor: '#505050', 
                    padding: '10px', // Padding para el contenido dentro del campo
                    borderRadius: '10px', // Radio de borde para suavizar las esquinas
                    iconColor: 'white'
                },
                invalid: {
                    color: '#FF6666', // Color del texto en caso de error
                },
            },
            hidePostalCode : true
        }

    async function getCards(){
        mostrar('cardAdm',1)
        ajax('payment/getcard',{token:user.token},(response)=>{
                    const {paymentMethods:pay}=response;
                    $("#cards").html("")
                    $("#cards_number").html(0)
                    $("#cardOption").html(`<option value="NO">Choose a card</option>`)
                    mostrar('cardAdm',2)
                    if(pay){
                        pay.forEach(e => {
                            if(e.isDefault){paymentMethod_default=e.id}
                            $("#cardOption").append(`<option value="${e.id}">${e.card.brand.toUpperCase()} (${e.card.last4} )</option>`)
                            $("#cards").append(`
                            <div class="col-12 col-lg-12 col-md-12" style="padding:2px 2px">
                                <div class="col-12" style="border-radius:10px;cursor:pointer;background:rgb(255,255,255,.2);color:#FFF;font-size:.8em;padding:10px;">
                                    <img src="assets/img/delete.png" title="Delete card" onclick="deleteCardStart('${e.id}','${e.card.last4}','${e.card.brand}')"  style="width:15px;margin-top:2px;float:right;display:${e.isDefault?"none":"block"};filter:invert(1)">
                                    <img src="assets/img/fav${e.isDefault?"_1":""}.png"  onclick="mark_as_fav('${e.id}')"  title="Choose as fav" style="width:18px;margin-top:1px;float:right;margin-right:5px;${e.isDefault?"":"filter:invert(1)"}">
                                    <img src="assets/img/${e.card.brand}.png" style="width:30px;border:1px solid #FFF;border-radius:3px;"> Ending: ${e.card.last4} ${e.isDefault?"[Default]":""}
                                </div>
                            </div>
                            `)
                        });
                        $("#cards").append(`
                        <div class="col-12 col-lg-12 col-md-12" style="padding:2px 2px">
                            <div class="col-12" onclick="if(!initStripFlag){initStripe();}mostrar('cardAdm',3)" style="border-radius:10px;padding:5px;color:#5AE4A8;text-align:center;cursor:pointer">
                                ADD NEW CARD
                            </div>
                        </div>
                        `)
                        $("#cards_number").html(pay.length)
                    }   
        })
    }
    

    $(document).ready();

    initStripFlag=false
    function initStripe() {
        console.log("Inicializado Stripe")
        $.getScript("https://js.stripe.com/v3/", function() {
        initStripFlag=true;
        // El script está cargado y listo para usarse
        console.log('Stripe.js está listo');
        const stripe = Stripe('pk_test_51PWFKSLW177YQySElQnjLIo1JZZ5FxhoFKVXppGrHuE4RWOtovrgSBmjnoOCpkjtIsdC7AqBCE8hCrXLokuTwiQS00qmtpE7no');
        const elements = stripe.elements();
        const cardElement = elements.create('card',styleStipe);
        const stripeAddCard=async () => {
            const paymentMethodId = await createPaymentMethod();
            if(paymentMethodId.error){mostrar('cardAdm',3);$("#addCard_problem").html(paymentMethodId.error.message);
            setTimeout(()=>{
                $("#addCard_problem").html("")
            },2500)
            return false;}
            const sendData = {
                userId:user.user.uid,
                paymentMethodId,
                token:user.token
            };
            console.log(sendData)
            ajax('payment/addcard',sendData,(response)=>{
                    console.log('Solicitud POST enviada correctamente', response);
                    getCards()
            });
            
        }
        
        const createPaymentMethod = async () => {
            mostrar('cardAdm',1)
            const cardName = document.querySelector('#card-name').value;
            const postalCode = document.querySelector('input').value;
            const formattedPostalCode = postalCode.padStart(5, '0');
            document.querySelector('input').value = postalCode.padStart(5, '0');
            
            const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: cardName,
                    address: {
                        postal_code: formattedPostalCode // Usar el código postal formateado
                    }
                },
            });

            if (error) {
                console.error(error);
                return {error};
            } else {
                if(cardName==""){
                    return {error:{message:"You must to enter a cardholder name"}};
                }
                return paymentMethod.id;
            }
        };

        cardElement.mount('#card-element');
        document.querySelector('#add-card-button').addEventListener('click',stripeAddCard );
        //$('#newCard').modal('show');;
        
        
    });
    }

    function deleteCardStart(id,last4,brand) { 
        $("#deleteCard_payment_id").val(id);
        $("#deleteCard_payment_img").attr("src","assets/img/"+brand+".png");
        $("#deleteCard_payment_last").html(last4);
        mostrar('cardAdm',4)
    }

        function delete_card(){
        mostrar('cardAdm',1)
        ajax("/payment/deletecard",{token:user.token,paymentMethodId:$("#deleteCard_payment_id").val()},(response)=>{
            getCards()
        });
    }
    function mark_as_fav(id){
        ajax("/payment/changedefault",{token:user.token,paymentMethodId: id},(response)=>{
            getCards()
        });
    }

        

        
    
  </script>
</body>
</html>
